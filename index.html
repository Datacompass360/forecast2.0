<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCompass 360</title>
    
    <!-- Favicon Placeholder -->
    <link rel="icon" href="https://icon.horse/icon/compass.com" type="image/png">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 3. Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 4. Font Awesome (REQ 1) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- 5. Custom Tailwind Configuration & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#001f3f',
                        'emerald': '#00A86B',
                        'gold': '#FFD700',
                        'light-green': '#c8e6c9', // For 50-60%
                        'dark-green': '#4caf50',  // For >=60%
                        'light-red': '#ffcdd2',
                        'light-gray': '#f0f4f8',
                    },
                    fontFamily: {
                        'sans': ['Poppins', 'sans-serif'], // For headings
                        'body': ['Roboto', 'sans-serif'],   // For body text
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #00A86B; /* Emerald */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #007a4e; /* Darker Emerald */
        }
        /* Pulse animation for logo */
        @keyframes pulse-compass {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 12px rgba(255, 215, 0, 0);
            }
        }
        .pulse-compass-animation {
            animation: pulse-compass 2s infinite;
            border-radius: 50%;
        }
        /* Style for active nav tab */
        .nav-tab-button.active {
            background-color: #00A86B; /* Emerald */
            color: white;
            font-weight: 600;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* REQ 2: Custom styles for conditional formatting */
        .row-home-win { background-color: #e8f5e9 !important; } /* Light green */
        .row-draw-win { background-color: #e3f2fd !important; } /* Light blue */
        .row-away-win { background-color: #fff3e0 !important; } /* Light orange */
        .row-fail { background-color: #ffebf0 !important; } /* Light red */
        .row-pending { background-color: #ffffff; }

        .row-home-win:hover { background-color: #dceddd !important; }
        .row-draw-win:hover { background-color: #d1e9fb !important; }
        .row-away-win:hover { background-color: #ffeacc !important; }
        .row-fail:hover { background-color: #ffe0e8 !important; }


        /* Chart.js size */
        .chart-container {
            width: 100%;
            max-width: 400px; /* 3x3 inches is small, this is a bit bigger */
            height: 400px;
            margin: auto;
        }
    
        /* Extra button micro-animations */
        .hover\:-translate-y-0.5:hover { transform: translateY(-2px); }
        .rounded-2xl { border-radius: 1rem; }

    
        /* Mixed Accent Palette */
        :root{
            --accent-1: #10b981; /* emerald */
            --accent-2: #2563eb; /* blue */
            --accent-3: #7c3aed; /* purple */
            --accent-4: #ef4444; /* red */
        }
        .accent-gradient {
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3));
            color: white;
        }
        .table-row-alt:nth-child(even){ background-color: rgba(15,23,42,0.03); }
        .sticky-header { position: sticky; top: 0; backdrop-filter: blur(4px); }
        .card { padding: 1rem; border-radius: 0.75rem; box-shadow: 0 6px 18px rgba(2,6,23,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.82)); }

    </style>
</head>
<body class="bg-gray-100">

    <!-- =================================================================== -->
    <!-- NOTIFICATION POPUP (Replaces alert())                               -->
    <!-- =================================================================== -->
    <div id="notification-popup" class="hidden fixed top-5 right-5 z-[100] p-4 rounded-lg shadow-lg text-white transition-all duration-300 max-w-sm">
        <span id="notification-message"></span>
    </div>

    <!-- =================================================================== -->
    <!-- LOADING SPINNER                                                     -->
    <!-- =================================================================== -->
    <div id="loading-spinner" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-t-emerald border-gray-200"></div>
        <p id="loading-message" class="mt-4 text-lg text-navy font-medium">Loading...</p>
    </div>

    <!-- =================================================================== -->
    <!-- LOGIN PAGE (Unchanged)                                              -->
    <!-- =================================================================== -->
    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-t from-navy to-gray-100 p-4">
        <div class="w-full max-w-md rounded-2xl bg-white p-8 shadow-2xl">
            <!-- Logo -->
            <div class="flex justify-center mb-6">
                <div class="p-3 rounded-full bg-navy">
                    <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>
                        <!-- Gold Accent -->
                        <polygon points="12 4 14 8 12 10 10 8" class="text-gold" fill="currentColor"></polygon>
                    </svg>
                </div>
            </div>
            <h2 class="text-center text-3xl font-bold text-navy mb-6">DataCompass 360</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="you@example.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="••••••••">
                </div>
                
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-emerald rounded border-gray-300 focus:ring-emerald">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                    <a href="#" id="forgot-password-link" class="text-sm font-medium text-emerald hover:text-navy">Forgot password?</a>
                </div>
                
                <button type="submit" id="login-button" class="w-full bg-emerald text-white py-2.5 rounded-lg font-semibold shadow-md hover:bg-opacity-90 transition duration-300">
                    Login
                </button>
                
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                
                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? 
                    <a href="#" id="show-signup-link" class="font-medium text-emerald hover:text-navy">Sign up</a>
                </p>
            </form>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- SIGNUP PAGE (Unchanged)                                             -->
    <!-- =================================================================== -->
    <div id="signup-page" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-t from-navy to-gray-100 p-4">
        <div class="w-full max-w-md rounded-2xl bg-white p-8 shadow-2xl">
            <h2 class="text-center text-3xl font-bold text-navy mb-6">Create Account</h2>
            
            <form id="signup-form">
                <div class="mb-4">
                    <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="John Doe">
                </div>
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signup-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="you@example.com">
                </div>
                <div class="mb-4">
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signup-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="Min. 6 characters">
                </div>
                <div class="mb-6">
                    <label for="signup-country" class="block text-sm font-medium text-gray-700 mb-1">Country (Optional)</label>
                    <input type="text" id="signup-country" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald focus:border-transparent" placeholder="United States">
                </div>
                
                <button type="submit" id="signup-button" class="w-full bg-emerald text-white py-2.5 rounded-lg font-semibold shadow-md hover:bg-opacity-90 transition duration-300">
                    Create Account
                </button>
                
                <p id="signup-error" class="text-red-500 text-sm mt-4 text-center"></p>

                <p class="text-center text-sm text-gray-600 mt-6">
                    Already have an account? 
                    <a href="#" id="show-login-link" class="font-medium text-emerald hover:text-navy">Login</a>
                </p>
            </form>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- DASHBOARD PAGE                                                      -->
    <!-- =================================================================== -->
    <div id="dashboard-page" class="hidden h-screen flex flex-col">
        <!-- REQ 7: Header Updated -->
        <header class="bg-navy text-white shadow-lg flex items-center justify-between px-6 py-3 z-10">
            <div class="flex items-center space-x-3">
                <!-- Logo with Pulse -->
                <div class="p-2 rounded-full bg-white pulse-compass-animation">
                    <svg class="w-8 h-8 text-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>
                        <polygon points="12 4 14 8 12 10 10 8" class="text-gold" fill="currentColor"></polygon>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold">DataCompass 360</h1>
            </div>
            
            <!-- Global Search -->
            <div class="relative w-full max-w-lg">
                <input type="search" id="global-search" class="w-full bg-white/20 text-white placeholder-gray-300 rounded-full py-2 px-5 pl-12 focus:outline-none focus:ring-2 focus:ring-gold" placeholder="Search by team, league, or date...">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <!-- REQ 7: Push to Firebase (Moved) -->
            <button id="push-to-firebase-btn" class="px-5 py-3 bg-emerald hover:bg-emerald-dark text-white rounded-2xl font-semibold shadow-xl flex items-center space-x-3 transition-transform transform hover:-translate-y-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                <span class="uppercase tracking-wide">Push to Firebase</span>
            </button>

            <button id="refresh-data-btn" class="px-4 py-2 bg-white text-emerald border border-emerald rounded-full hover:shadow-md font-medium shadow-sm flex items-center space-x-2 transition transform hover:-translate-y-0.5 ml-4" title="Refresh data from Google Sheet & Firebase">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 20v-6h-6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a9 9 0 1114 0" />
                </svg>
                <span class="uppercase tracking-wide">Refresh</span>
            </button>

            <!-- User Menu (Unchanged) -->
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm text-gray-300">Welcome,</div>
                    <div id="user-email" class="font-medium">user@example.com</div>
                </div>
                <button id="logout-button" class="bg-emerald text-white rounded-full p-2.5 hover:bg-opacity-90 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
            <!-- Finished Matches Tab Button (added) -->
            
        <div class="flex flex-1 overflow-hidden">
            <!-- Navigation Sidebar (Unchanged) -->
            <nav class="w-64 bg-navy text-gray-300 flex-shrink-0 p-4 space-y-2 overflow-y-auto">
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="all-matches">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M12 16h.01" /></svg>
                    <span>🏆 All Matches</span>
                </button>
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="selections">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span>📋 Selections</span>
                </button>
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="high-chance">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343m11.314 11.314a8 8 0 01-11.314-11.314m11.314 11.314L22 22M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-4.364l-.707.707M6.343 17.657l-.707.707m12.02-12.02l-.707-.707M6.343 6.343l-.707-.707" /></svg>
                    <span>🔥 High Chance</span>
                </button>
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="statistics">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                    <span>📊 Statistics</span>
                </button>
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="finished-matches">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    <span>✅ Finished Matches</span>
                </button>

                <!-- === NEW TABS ADDED HERE === -->
            
                <a href="email.html" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>📧 Email Integration</span>
                </a>
                <!-- === END NEW TABS === -->

                <button id="admin-nav-button" class="hidden nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="admin">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    <span>👑 Admin</span>
                </button>
            </nav>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-100 p-6">
                <!-- 
                  =======================
                  TAB: All Matches (UPDATED)
                  ======================= 
                -->
                <div id="all-matches-tab" class="tab-content">

                    <!-- REQ 3: Summary Cards Container REMOVED -->
    
                    <!-- REQ 7: Title and Button DIV removed -->
                    
                    <!-- REQ 7: Main Filters (Moved up) -->
                    <div class="bg-white rounded-xl shadow-lg p-5">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- League -->
                            <div>
                                <label for="filter-league" class="block text-sm font-medium text-gray-700">League</label>
                                <select id="filter-league" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All Leagues</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <!-- REQ 1: Date Dropdown -->
                            <div>
                                <label for="filter-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <select id="filter-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All Dates</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <!-- REQ 3: Correct Score (Dropdown) -->
                            <div>
                                <label for="filter-correct-score" class="block text-sm font-medium text-gray-700">Correct Score</label>
                                <select id="filter-correct-score" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <!-- REQ 3: Recommendation Tip (Dropdown) -->
                            <div>
                                <label for="filter-recommendation-tip" class="block text-sm font-medium text-gray-700">Recommendation Tip</label>
                                <select id="filter-recommendation-tip" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <!-- Predicted Total Goals -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Predicted Total Goals</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-pred-goals-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-pred-goals-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                            <!-- Goals to be Scored -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Goals to be Scored</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-goals-scored-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-goals-scored-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                            <!-- Home Team Power -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Home Power</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-home-power-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-home-power-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                            <!-- Away Team Power -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Away Power</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-away-power-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-away-power-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                             <!-- Home Team Table Standing -->
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Home Standing</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-home-standing-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-home-standing-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                            <!-- Away Team Table Standing -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Away Standing</label>
                                <div class="flex space-x-2 mt-1">
                                    <input type="number" id="filter-away-standing-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    <input type="number" id="filter-away-standing-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-end space-x-3 mt-4">
                            <button id="more-filters-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">
                                More Filters
                            </button>
                            <button id="reset-all-filters-main" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
                                Reset
                            </button>
                            <button id="apply-filters-main" class="px-4 py-2 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium">
                                Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- REQ 3 & 6: Summary Cards (Repositioned) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 my-6">
                        <!-- REQ 3: Total Matches (Moved) -->
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">Total Matches</h4>
                            <p class="text-2xl font-bold text-navy" id="card-total-matches">0</p>
                        </div>
                        <!-- Card 1: Prediction -->
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Prediction" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-all-matches-pred-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-all-matches-pred-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <!-- Card 2: Predicted Outcome -->
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Predicted Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-all-matches-po-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-all-matches-po-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <!-- Card 3: Expected Outcome -->
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Expected Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-all-matches-eo-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-all-matches-eo-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                    </div>

                    <!-- REQ 1, 3 & 4: Match Table (UPDATED) -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sel</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⭐</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <!-- REQ 1: Actions Moved -->
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odds (H/D/A)</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C. Score</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prediction</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conf. %</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pred. Outcome</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pred. Prob. %</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Outcome</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prob. Rate</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Goals</th>
                                        <!-- REQ 3: H Win, Draw, A Win removed -->
                                    </tr>
                                </thead>
                                <tbody id="matches-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div id="main-pagination" class="flex items-center justify-between px-4 py-3 border-t border-gray-200 sm:px-6">
                            <div class="text-sm text-gray-700">
                                Showing <span id="page-info-start">1</span> to <span id="page-info-end">30</span> of <span id="page-info-total">0</span> results
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Previous
                                </button>
                                <button id="next-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Selections (UPDATED)
                  ======================= 
                -->
                <div id="selections-tab" class="tab-content hidden">
                    <h1 class="text-3xl font-bold text-navy mb-6">My Selections</h1>
                    
                    <!-- REQ 6: Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Prediction" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-sel-pred-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-sel-pred-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Predicted Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-sel-po-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-sel-po-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Expected Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-sel-eo-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-sel-eo-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                    </div>
                    
                    <!-- REQ 5: Selections Controls -->
                    <div class="bg-white rounded-xl shadow-lg p-5 mb-6 flex flex-wrap items-center justify-between gap-4">
                        <!-- Left side: Load/Save -->
                        <div class="flex-grow flex flex-wrap items-center gap-3">
                            <!-- REQ 5: Added 'multiple' and 'size' -->
                            <select id="load-collection-select" multiple size="5" class="w-full sm:w-auto rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                <!-- Loaded by JS -->
                            </select>
                            <input type="text" id="collection-name" placeholder="Name new collection..." class="w-full sm:w-auto flex-grow rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <!-- REQ 5: Added Merge Button -->
                            <button id="merge-collections-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium w-full sm:w-auto">
                                Merge Selected
                            </button>
                            <button id="save-collection-btn" class="px-4 py-2 bg-emerald text-white rounded-lg hover:bg-opacity-90 font-medium w-full sm:w-auto">
                                Save Collection
                            </button>
                        </div>
                        <!-- Right side: Export -->
                        <div class="flex space-x-3">
                            <button id="export-csv-btn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-medium flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                <span>CSV</span>
                            </button>
                            <button id="export-pdf-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                <span>PDF</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- REQ 2 & 4: Selections Table (UPDATED) -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⭐</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prediction</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conf. %</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Goals</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="selections-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: High Chance (UPDATED)
                  ======================= 
                -->
                <div id="high-chance-tab" class="tab-content hidden">
                    <!-- UPDATED: Filters -->
                    <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date</label>
                                <select id="filter-date-highchance" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">All Dates</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">League</label>
                                <select id="filter-league-highchance" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">All Leagues</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Correct Score</label>
                                <select id="filter-correctscore-highchance" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">Any</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <!-- ADDED: Recommend Tip Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Recommend Tip</label>
                                <select id="filter-recommendtip-highchance" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">Any</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Confidence %</label>
                                <select id="filter-confidence-highchance" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">Any</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-navy">High Chance Matches</h1>
                        <p class="text-lg text-gray-600">Conf. ≥ 60% & Pred. Prob. > 50% & Prob. Rate > 45</p>
                    </div>

                    <!-- REQ 6: Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Prediction" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-hc-pred-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-hc-pred-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Predicted Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-hc-po-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-hc-po-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h4 class="text-sm font-medium text-gray-500">"Expected Outcome" Field</h4>
                            <p class="text-2xl font-bold text-navy" id="card-hc-eo-total">0</p>
                            <p class="text-sm text-gray-500">Total Predictions</p>
                            <p class="text-2xl font-bold text-emerald mt-2" id="card-hc-eo-wins">0</p>
                            <p class="text-sm text-gray-500">Total Wins</p>
                        </div>
                    </div>

                    <!-- REQ 2: UPDATED: High Chance Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gold">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <!-- UPDATED: Table Head -->
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Team</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Odds</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Draw Odds</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Odds</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Match Result</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predicted Outcome</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Outcome</th>
                                    </tr>
                                </thead>
                                <tbody id="high-chance-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                         <!-- Pagination for High Chance -->
                         <div id="high-chance-pagination" class="hidden flex items-center justify-between px-4 py-3 border-t border-gray-200 sm:px-6">
                            <div class="text-sm text-gray-700">
                                Showing <span id="hc-page-info-start">1</span> to <span id="hc-page-info-end">30</span> of <span id="hc-page-info-total">0</span> results
                            </div>
                            <div class="flex space-x-2">
                                <button id="hc-prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Previous
                                </button>
                                <button id="hc-next-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Statistics (UPDATED)
                  ======================= 
                -->
                <div id="statistics-tab" class="tab-content hidden">
                    <h1 class="text-3xl font-bold text-navy mb-6">System Statistics</h1>

                    <!-- REQ 4: Statistics Filters -->
                    <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="filter-league-stats" class="block text-sm font-medium text-gray-700">League</label>
                                <select id="filter-league-stats" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All Leagues</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-date-stats" class="block text-sm font-medium text-gray-700">Date</label>
                                <select id="filter-date-stats" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring focus:ring-emerald focus:ring-opacity-50">
                                    <option value="">All Dates</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics (UPDATED) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" /></svg>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Total Predictions</div>
                                <div id="stats-total-predictions" class="text-3xl font-bold text-navy">0</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-emerald text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Total Wins</div>
                                <div id="stats-total-wins" class="text-3xl font-bold text-emerald">0</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-gold text-navy">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Win Rate</div>
                                <div id="stats-win-rate" class="text-3xl font-bold text-navy">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts (UPDATED) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Chart 1: Prediction -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-navy mb-4 text-center">"Prediction" Field Stats</h3>
                            <div class="chart-container">
                                <canvas id="chart-prediction"></canvas>
                            </div>
                        </div>
                        <!-- Chart 2: Predicted Outcome -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-navy mb-4 text-center">"Predicted Outcome" Field Stats</h3>
                            <div class="chart-container">
                                <canvas id="chart-predicted-outcome"></canvas>
                            </div>
                        </div>
                        <!-- Chart 3: Expected Outcome -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-navy mb-4 text-center">"Expected Outcome" Field Stats</h3>
                            <div class="chart-container">
                                <canvas id="chart-expected-outcome"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Finished Matches
                  ======================= 
                -->
                <div id="finished-matches-tab" class="tab-content hidden">
                    <h1 class="text-3xl font-bold text-navy mb-6">Finished Matches</h1>
                    <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="filter-league-finished" class="block text-sm font-medium text-gray-700">League</label>
                                <select id="filter-league-finished" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">All Leagues</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date-finished" class="block text-sm font-medium text-gray-700">Date</label>
                                <select id="filter-date-finished" class="mt-1 block w-full rounded-lg border-gray-300">
                                    <option value="">All Dates</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="apply-filters-finished" class="px-4 py-2 bg-emerald text-white rounded-lg">Apply Filters</button>
                            </div>
                        </div>
                    </div>

                    <!-- This tab will re-use the MAIN table body 'matches-table-body' -->
                    <!-- The table structure below is just a placeholder and not used by the new JS logic -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">✔</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home</th>
                                        <!-- ... other headers ... -->
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="finished-matches-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- This body is NOT rendered to. 'matches-table-body' is used. -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Admin (Unchanged)
                  ======================= 
                -->
                <div id="admin-tab" class="tab-content hidden">
                    <h1 class="text-3xl font-bold text-navy mb-6">Admin Dashboard</h1>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-navy">User Management</h3>
                            <p class="text-gray-600 mt-1">Create, edit, or deactivate users and manage their roles.</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Admin users list populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Create New User Form -->
                    <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                        <h3 class="text-lg font-semibold mb-3">Create New User</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="admin-new-username" placeholder="Full name" class="rounded-lg border-gray-300 p-2">
                            <input type="email" id="admin-new-email" placeholder="Email" class="rounded-lg border-gray-300 p-2">
                            <select id="admin-new-role" class="rounded-lg border-gray-300 p-2">
                                <option value="Standard User">Standard User</option>
                                <option value="Analyst">Analyst</option>
                                <option value="Admin">Admin</option>
                            </select>
                            <input type="password" id="admin-new-password" placeholder="Password (min 6)" class="rounded-lg border-gray-300 p-2">
                        </div>
                        <div class="mt-4">
                            <button id="admin-create-user-btn" class="px-4 py-2 bg-emerald text-white rounded-lg">Create User</button>
                            <span id="admin-create-user-msg" class="text-sm ml-3"></span>
                        </div>
                    </div>
                </div>

                <!-- 
    

    <!-- =================================================================== -->
    <!-- MODALS                                                              -->
    <!-- =================================================================== -->

    <!-- More Filters Modal (UPDATED) -->
    <div id="more-filters-modal" class="hidden fixed inset-0 z-30 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl transform transition-all" role="dialog" aria-modal="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-2xl font-semibold text-navy">Additional Filters</h3>
                <button id="close-more-filters-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-4">
                    <!-- Hteam Avg Scored -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">H-Team Avg Scored</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-h-avg-scored-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-h-avg-scored-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Hteam Avg Conceded -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">H-Team Avg Conceded</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-h-avg-conceded-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-h-avg-conceded-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- HTeam Power - Over 2.5 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">H-Team Power OV2.5</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-h-power-ov25-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-h-power-ov25-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Ateam Avg Scored -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">A-Team Avg Scored</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-a-avg-scored-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-a-avg-scored-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Ateam Avg Conceded -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">A-Team Avg Conceded</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-a-avg-conceded-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-a-avg-conceded-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- ATeam Power - Over 2.5 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">A-Team Power OV2.5</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-a-power-ov25-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-a-power-ov25-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Home Team Power -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Home Team Power</g-label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-h-power-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-h-power-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Away Team Power -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Away Team Power</g-label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-a-power-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-a-power-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- Spacer -->
                    <div></div> 
                    <!-- HTeam Power - BTTS -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">H-Team Power BTTS</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-h-power-btts-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-h-power-btts-max" placeholder="Max" class="w-1/Added/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>
                    <!-- ATeam Power - BTTS -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">A-Team Power BTTS</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="filter-a-power-btts-min" placeholder="Min" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <input type="number" id="filter-a-power-btts-max" placeholder="Max" class="w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                        </div>
                    </div>

                </div>
            </div>
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-xl">
                <button id="reset-modal-filters" class="px-5 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">Reset</button>
                <button id="apply-modal-filters" class="px-5 py-2.5 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- REQ 1 & 3: Match Details Modal (UPDATED) -->
    <div id="match-details-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-60 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] transform transition-all flex flex-col" role="dialog" aria-modal="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <h3 id="modal-match-title" class="text-2xl font-semibold text-navy">Match Details</h3>
                <button id="close-match-details-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <!-- Modal Body (Simplified, no charts) -->
            <div class="p-6 overflow-y-auto">
                <!-- Team Comparison Table -->
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-1/3">Metric</th>
                            <th id="modal-home-team" class="px-4 py-3 text-center text-sm font-semibold text-gray-700 w-1/3">Home Team</th>
                            <th id="modal-away-team" class="px-4 py-3 text-center text-sm font-semibold text-gray-700 w-1/3">Away Team</th>
                        </tr>
                    </thead>
                    <tbody id="modal-comparison-table" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- JAVASCRIPT (Significantly updated)                                  -->
    <!-- =================================================================== -->
    <script type="module">
        // -------------------------------------------
        // Firebase SDK Imports
        // -------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            onValue,
            get,
            set,
            child
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // -------------------------------------------
        // Firebase Config & Initialization
        // -------------------------------------------

        // Config from your prompt
        const firebaseConfig = {
            apiKey: "AIzaSyB7P5UCzyp5dnMO0E81PQwp5esUDNFCKzg",
            authDomain: "datacompass360-3b5d9.firebaseapp.com",
            databaseURL: "https://datacompass360-3b5d9-default-rtdb.firebaseio.com",
            projectId: "datacompass360-3b5d9",
            storageBucket: "datacompass360-3b5d9.firebasestorage.app",
            messagingSenderId: "836940314719",
            appId: "1:836940314719:web:7088bbdf2a6c446dddc3ea",
            measurementId: "G-PSE21XN3KL"
        };
        
        // Use injected config if available, otherwise fallback
        const firebaseConfigString = typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : JSON.stringify(firebaseConfig);
        
        const effectiveConfig = JSON.parse(firebaseConfigString);
        
        const app = initializeApp(effectiveConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const dbRef = ref(db); // Root ref

        // -------------------------------------------
        // Global State
        // -------------------------------------------
        const GOOGLE_SHEET_URL = "https://corsproxy.io/?" + encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vT9E7TTXJgBm3CBY0Oydz5qQ_QLaP-8Za5O2GSitCWFvOSI9tt-nEaSS64P7NPX6h6aJluZ4bA16nIO/pub?gid=0&single=true&output=csv");
        
        // --- NEW: High Chance Sheet URL ---
        const HIGH_CHANCE_SHEET_URL = "https://corsproxy.io/?" + encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vT9E7TTXJgBm3CBY0Oydz5qQ_QLaP-8Za5O2GSitCWFvOSI9tt-nEaSS64P7NPX6h6aJluZ4bA16nIO/pub?gid=0&single=true&output=csv");

        // This is a list of all column names from the sheet that are expected to be numbers
        const numericColumns = [
            "Home Odds", "Draw Odds", "Away Odds", "Home Form Rate", "Away Form Rate",
            "Confidence %", "Home Team Table Standing", "Away Team Table Standing",
            "L5 H-Team Overall W", "L5 H-Team Home W", "L5 A-Team Overall W", "L5 A-Team Away W",
            "HTeam % -OV1.5", "HTeam % -OV2.5", "HTeam % -OV3.5",
            "ATeam % -OV1.5", "ATeam % -OV2.5", "ATeam % -OV3.5",
            "Hteam Avg Scored", "Hteam Avg Conceded", "Ateam Avg Scored", "Ateam Avg Conceded",
            "HTeam Power - Over 2.5", "HTeam Power - BTTS", "Home Team Power",
            "ATeam Power - Over 2.5", "ATeam Power - BTTS", "Away Team Power",
            "Predicted Probability (%)", "Probability Rate", "Goals to be Scored",
            "Home Win", "Draw", "Away Win", "Home FT", "Away FT"
        ];

        // --- UPDATED DATA STATE ---
        let allMatchesData = [];        // Combined data from GSheet + Firebase (for lookups)
        let googleSheetMatchesData = [];// Raw data from GSheet (for All Matches)
        let highChanceSheetData = [];   // NEW: Raw data from GSheet (for High Chance)
        let firebaseMatchesData = [];   // Raw data from Firebase (for Finished Matches)
        // --- END UPDATED DATA STATE ---

        let filteredMatches = [];   // Data after all filters
        let selections = [];      // Array of selected MatchKey
        let currentUser = null;
        let currentUserRole = 'Standard User'; // Default role
        let currentPage = 1;
        let hcCurrentPage = 1; // High Chance page
        const rowsPerPage = 30;
        let activeTab = 'all-matches';
        
        // Chart instances
        let charts = {
            prediction: null,
            predictedOutcome: null,
            expectedOutcome: null
        };

        // DOM Element Cache
        const dom = {
            loadingSpinner: document.getElementById('loading-spinner'),
            loadingMessage: document.getElementById('loading-message'),
            loginPage: document.getElementById('login-page'),
            signupPage: document.getElementById('signup-page'),
            dashboardPage: document.getElementById('dashboard-page'),
            loginForm: document.getElementById('login-form'),
            loginEmail: document.getElementById('login-email'),
            loginPassword: document.getElementById('login-password'),
            loginError: document.getElementById('login-error'),
            rememberMe: document.getElementById('remember-me'),
            signupForm: document.getElementById('signup-form'),
            signupName: document.getElementById('signup-name'),
            signupEmail: document.getElementById('signup-email'),
            signupPassword: document.getElementById('signup-password'),
            signupCountry: document.getElementById('signup-country'),
            signupError: document.getElementById('signup-error'),
            showSignupLink: document.getElementById('show-signup-link'),
            showLoginLink: document.getElementById('show-login-link'),
            logoutButton: document.getElementById('logout-button'),
            userEmailDisplay: document.getElementById('user-email'),
            adminNavButton: document.getElementById('admin-nav-button'),
            navTabButtons: document.querySelectorAll('.nav-tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            matchesTableBody: document.getElementById('matches-table-body'),
            highChanceTableBody: document.getElementById('high-chance-table-body'), // Reactivated
            selectionsTableBody: document.getElementById('selections-table-body'),
            usersTableBody: document.getElementById('users-table-body'),
            notification: {
                popup: document.getElementById('notification-popup'),
                message: document.getElementById('notification-message'),
            },
            pagination: {
                container: document.getElementById('main-pagination'),
                prev: document.getElementById('prev-page'),
                next: document.getElementById('next-page'),
                start: document.getElementById('page-info-start'),
                end: document.getElementById('page-info-end'),
                total: document.getElementById('page-info-total'),
            },
            hcPagination: {
                container: document.getElementById('high-chance-pagination'),
                prev: document.getElementById('hc-prev-page'),
                next: document.getElementById('hc-next-page'),
                start: document.getElementById('hc-page-info-start'),
                end: document.getElementById('hc-page-info-end'),
                total: document.getElementById('hc-page-info-total'),
            },
            filters: {
                // Main
                league: document.getElementById('filter-league'),
                date: document.getElementById('filter-date'), // REQ 1: This is now a <select>
                correctScore: document.getElementById('filter-correct-score'), // REQ 3: Now <select>
                recommendationTip: document.getElementById('filter-recommendation-tip'), // REQ 3: Now <select>
                predGoalsMin: document.getElementById('filter-pred-goals-min'),
                predGoalsMax: document.getElementById('filter-pred-goals-max'),
                goalsScoredMin: document.getElementById('filter-goals-scored-min'),
                goalsScoredMax: document.getElementById('filter-goals-scored-max'),
                homePowerMin: document.getElementById('filter-home-power-min'),
                homePowerMax: document.getElementById('filter-home-power-max'),
                awayPowerMin: document.getElementById('filter-away-power-min'),
                awayPowerMax: document.getElementById('filter-away-power-max'),
                homeStandingMin: document.getElementById('filter-home-standing-min'),
                homeStandingMax: document.getElementById('filter-home-standing-max'),
                awayStandingMin: document.getElementById('filter-away-standing-min'),
                awayStandingMax: document.getElementById('filter-away-standing-max'),
                globalSearch: document.getElementById('global-search'),
                // Modal
                hAvgScoredMin: document.getElementById('filter-h-avg-scored-min'),
                hAvgScoredMax: document.getElementById('filter-h-avg-scored-max'),
                hAvgConcededMin: document.getElementById('filter-h-avg-conceded-min'),
                hAvgConcededMax: document.getElementById('filter-h-avg-conceded-max'),
                hPowerOv25Min: document.getElementById('filter-h-power-ov25-min'),
                hPowerOv25Max: document.getElementById('filter-h-power-ov25-max'),
                aAvgScoredMin: document.getElementById('filter-a-avg-scored-min'),
                aAvgScoredMax: document.getElementById('filter-a-avg-scored-max'),
                aAvgConcededMin: document.getElementById('filter-a-avg-conceded-min'),
                aAvgConcededMax: document.getElementById('filter-a-avg-conceded-max'),
                aPowerOv25Min: document.getElementById('filter-a-power-ov25-min'),
                aPowerOv25Max: document.getElementById('filter-a-power-ov25-max'),
                hPowerMin: document.getElementById('filter-h-power-min'),
                hPowerMax: document.getElementById('filter-h-power-max'),
                aPowerMin: document.getElementById('filter-a-power-min'),
                aPowerMax: document.getElementById('filter-a-power-max'),
                hPowerBttsMin: document.getElementById('filter-h-power-btts-min'),
                hPowerBttsMax: document.getElementById('filter-h-power-btts-max'),
                aPowerBttsMin: document.getElementById('filter-a-power-btts-min'),
                aPowerBttsMax: document.getElementById('filter-a-power-btts-max'),
                // NEW: High Chance Filters
                hc: {
                    date: document.getElementById('filter-date-highchance'),
                    league: document.getElementById('filter-league-highchance'),
                    correctScore: document.getElementById('filter-correctscore-highchance'),
                    confidence: document.getElementById('filter-confidence-highchance'),
                    recommendTip: document.getElementById('filter-recommendtip-highchance')
                },
                // Finished
                finished: {
                    league: document.getElementById('filter-league-finished'),
                    date: document.getElementById('filter-date-finished'),
                    apply: document.getElementById('apply-filters-finished')
                },
                // REQ 4: Statistics Filters
                statsLeague: document.getElementById('filter-league-stats'),
                statsDate: document.getElementById('filter-date-stats'),
            },
            filterButtons: {
                pushToFirebase: document.getElementById('push-to-firebase-btn'),
                refreshData: document.getElementById('refresh-data-btn'),
                moreFilters: document.getElementById('more-filters-button'),
                closeMoreFilters: document.getElementById('close-more-filters-modal'),
                applyMain: document.getElementById('apply-filters-main'),
                resetMain: document.getElementById('reset-all-filters-main'),
                applyModal: document.getElementById('apply-modal-filters'),
                resetModal: document.getElementById('reset-modal-filters'),
            },
            modals: {
                moreFilters: document.getElementById('more-filters-modal'),
                matchDetails: document.getElementById('match-details-modal'),
                closeMatchDetails: document.getElementById('close-match-details-modal'),
                matchTitle: document.getElementById('modal-match-title'),
                homeTeam: document.getElementById('modal-home-team'),
                awayTeam: document.getElementById('modal-away-team'),
                comparisonTable: document.getElementById('modal-comparison-table'),
            },
            stats: {
                totalPredictions: document.getElementById('stats-total-predictions'),
                totalWins: document.getElementById('stats-total-wins'),
                winRate: document.getElementById('stats-win-rate'),
            },
            selections: {
                saveBtn: document.getElementById('save-collection-btn'),
                loadSelect: document.getElementById('load-collection-select'),
                collectionName: document.getElementById('collection-name'),
                exportCsv: document.getElementById('export-csv-btn'),
                exportPdf: document.getElementById('export-pdf-btn'),
                mergeBtn: document.getElementById('merge-collections-btn'), // REQ 5
            }
        };

        // -------------------------------------------
        // UTILITY FUNCTIONS
        // -------------------------------------------

        /**
         * Shows a notification popup.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' (green), 'error' (red), or 'info' (blue).
         */
        function showNotification(message, type = 'info') {
            const popup = dom.notification.popup;
            dom.notification.message.textContent = message;

            // Remove old classes
            popup.classList.remove('bg-emerald', 'bg-red-500', 'bg-blue-500', 'hidden');

            if (type === 'success') {
                popup.classList.add('bg-emerald');
            } else if (type === 'error') {
                popup.classList.add('bg-red-500');
            } else {
                popup.classList.add('bg-blue-500');
            }

            popup.classList.remove('hidden');

            // Hide after 3 seconds
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
        }

        /**
         * A simple CSV parser that handles quoted fields.
         * @param {string} csvText - The raw CSV text.
         * @returns {Array<Object>} An array of objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentLine = lines[i];
                let inQuote = false;
                let value = '';

                for (let j = 0; j < currentLine.length; j++) {
                    const char = currentLine[j];

                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(value.trim());
                        value = '';
                    } else {
                        value += char;
                    }
                }
                values.push(value.trim()); // Add last value

                if (values.length === headers.length) {
                    const obj = {};
                    for (let k = 0; k < headers.length; k++) {
                        obj[headers[k]] = values[k];
                    }
                    data.push(obj);
                }
            }
            return data;
        }

        /**
         * Parses a match object from CSV (strings) into correct data types.
         * @param {Object} row - A row object from parseCSV.
         * @returns {Object} A row object with numbers parsed.
         */
        function parseMatchObject(row) {
            const newRow = { ...row };
            for (const col of numericColumns) {
                if (newRow[col]) {
                    const val = parseFloat(newRow[col]);
                    newRow[col] = isNaN(val) ? null : val;
                } else {
                    newRow[col] = null;
                }
            }
            // REQ 2: Do not parse or reformat the Date. Treat it as raw text.
            return newRow;
        }

        /**
         * Gets the match outcome (Home, Draw, Away) from a score string.
         * @param {string} score - e.g., "2-1", "1-1", "0-3"
         * @returns {string|null} "Home", "Draw", "Away", or null if invalid.
         */
        function getMatchOutcome(score) {
            if (!score || !score.includes('-')) return null;
            const parts = score.split('-').map(s => parseInt(s.trim()));
            if (isNaN(parts[0]) || isNaN(parts[1])) return null;
            
            if (parts[0] > parts[1]) return "Home";
            if (parts[0] < parts[1]) return "Away";
            if (parts[0] === parts[1]) return "Draw";
            return null;
        }

        /**
         * REQ 4: Calculates total goals from a score string.
         * @param {string} result - e.g., "2-1", "1-1", "0-3"
         * @returns {string|number} The total goals (e.g., 3) or "—" if invalid.
         */
        function calculateTotalGoals(result) {
            if (!result || !result.includes('-')) return '—';
            const parts = result.split('-').map(s => parseInt(s.trim()));
            if (isNaN(parts[0]) || isNaN(parts[1])) return '—';
            return parts[0] + parts[1];
        }
        
        // -------------------------------------------
        // AUTHENTICATION (Unchanged)
        // -------------------------------------------

        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                dom.userEmailDisplay.textContent = user.email;
                setLoadingMessage("Fetching user permissions...");
                
                // Fetch user role
                try {
                    const snapshot = await get(child(dbRef, 'users/' + user.uid));
                    if (snapshot.exists()) {
                        currentUserRole = snapshot.val().role || 'Standard User';
                    } else {
                        currentUserRole = 'Standard User';
                    }
                } catch (error) {
                    console.error("Error fetching user role:", error);
                    currentUserRole = 'Standard User';
                }
                
                setupUIForRole(currentUserRole);
                showPage('dashboard');
                await fetchMatchData(); // Fetch data only after login
                await loadUserSelections(); // Load user's saved selections
            } else {
                currentUser = null;
                showPage('login');
                dom.loadingSpinner.classList.add('hidden');
            }
        });

        // Login Form Submission
        dom.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            dom.loginError.textContent = '';
            const email = dom.loginEmail.value;
            const password = dom.loginPassword.value;
            const persistence = dom.rememberMe.checked ? browserLocalPersistence : browserSessionPersistence;

            setPersistence(auth, persistence)
                .then(() => {
                    return signInWithEmailAndPassword(auth, email, password);
                })
                .catch((error) => {
                    dom.loginError.textContent = getFriendlyAuthError(error.code);
                });
        });

        // Signup Form Submission
        dom.signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            dom.signupError.textContent = '';
            const name = dom.signupName.value;
            const email = dom.signupEmail.value;
            const password = dom.signupPassword.value;
            const country = dom.signupCountry.value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    set(ref(db, 'users/' + user.uid), {
                        fullName: name,
                        email: email,
                        country: country,
                        role: 'Standard User',
                        status: 'Active',
                        createdAt: new Date().toISOString()
                    }).catch((dbError) => {
                        console.error("Error saving user data:", dbError);
                        showNotification("Account created, but failed to save user details.", "error");
                    });
                })
                .catch((error) => {
                    dom.signupError.textContent = getFriendlyAuthError(error.code);
                });
        });

        // Admin Create User button handler
        document.getElementById('admin-create-user-btn')?.addEventListener('click', async (ev) => {
            ev.preventDefault();
            const msgEl = document.getElementById('admin-create-user-msg');
            msgEl.textContent = '';
            const name = document.getElementById('admin-new-username').value.trim();
            const email = document.getElementById('admin-new-email').value.trim();
            const password = document.getElementById('admin-new-password').value;
            const role = document.getElementById('admin-new-role').value;
            if (!email || !password) {
                msgEl.textContent = 'Email and password required.';
                return;
            }
            try {
                // This is a simplified auth flow for demo.
                // In a real app, you'd use Admin SDK or a Cloud Function.
                // This will sign in the *admin* as the new user.
                // We'll just create the user data.
                
                // This is a placeholder. Real user creation requires Admin SDK.
                // We will simulate it by just writing to the database.
                // For a real app, you MUST use a backend function.
                // Since we can't do that here, we'll just show a message.
                // To make it functional, we will use the admin's auth to create a user.
                // This is NOT secure and is for demo only.
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                const u = userCred.user;
                await set(ref(db, 'users/' + u.uid), {
                    fullName: name,
                    email: email,
                    role: role || 'Standard User',
                    status: 'Active',
                    createdAt: new Date().toISOString()
                });
                msgEl.textContent = 'User created (demo).';
                fetchAdminUsers();
                
                // Sign the admin back in
                // This is a hack for demo.
                showNotification("User created. You may need to re-login.", "info");

            } catch (err) {
                console.error('Admin create user error', err);
                msgEl.textContent = getFriendlyAuthError(err.code) || 'Failed to create user.';
            }
        });

        // Logout Button
        dom.logoutButton.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // Auth Page Toggling
        dom.showSignupLink.addEventListener('click', (e) => { e.preventDefault(); showPage('signup'); });
        dom.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showPage('login'); });

        // -------------------------------------------
        // UI & NAVIGATION
        // -------------------------------------------

        function setLoadingMessage(message) {
            dom.loadingMessage.textContent = message;
        }

        function showPage(pageId) {
            dom.loginPage.classList.add('hidden');
            dom.signupPage.classList.add('hidden');
            dom.dashboardPage.classList.add('hidden');
            
            if (pageId === 'login') dom.loginPage.classList.remove('hidden');
            if (pageId === 'signup') dom.signupPage.classList.remove('hidden');
            if (pageId === 'dashboard') dom.dashboardPage.classList.remove('hidden');
        }
        
        function setupUIForRole(role) {
            // Hide all restricted elements by default
            dom.adminNavButton.classList.add('hidden');
            const statsTabBtn = document.querySelector('.nav-tab-button[data-tab="statistics"]');
            const selectionsTabBtn = document.querySelector('.nav-tab-button[data-tab="selections"]');
            
            if (statsTabBtn) statsTabBtn.classList.add('hidden');
            if (selectionsTabBtn) selectionsTabBtn.classList.add('hidden');

            // Show elements based on role
            if (role === 'Admin') {
                dom.adminNavButton.classList.remove('hidden');
                if (statsTabBtn) statsTabBtn.classList.remove('hidden');
                if (selectionsTabBtn) selectionsTabBtn.classList.remove('hidden');
            } else if (role === 'Analyst') {
                if (statsTabBtn) statsTabBtn.classList.remove('hidden');
                if (selectionsTabBtn) selectionsTabBtn.classList.remove('hidden');
            } else {
                // Standard User (All Matches + High Chance)
                // They are visible by default
            }
            
            // Set default tab
            switchTab('all-matches');
        }

        // Tab Switching
        dom.navTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                switchTab(tabName);
            });
        });
        
        function switchTab(tabName) {
            activeTab = tabName;
            
            dom.tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            dom.navTabButtons.forEach(button => {
                button.classList.remove('active');
            });

            const activeContent = document.getElementById(`${tabName}-tab`);
            const activeButton = document.querySelector(`.nav-tab-button[data-tab="${tabName}"]`);
            
            if (activeContent) activeContent.classList.remove('hidden');
            if (activeButton) activeButton.classList.add('active');

            // Reset pagination and render
            currentPage = 1;
            hcCurrentPage = 1;
            applyFiltersAndRender(); // This will now handle tab-specific logic

            // Special actions on tab switch
            if (tabName === 'statistics') {
                renderStatistics();
            } else if (tabName === 'admin') {
                fetchAdminUsers();
            } else if (tabName === 'selections') {
                renderSelectionsTable();
            }
        }

        // -------------------------------------------
        // DATA FETCHING & PROCESSING (REBUILT)
        // -------------------------------------------
        
        async function fetchMatchData() {
            setLoadingMessage("Fetching data sources...");
            dom.loadingSpinner.classList.remove('hidden');
            
            // --- NEW: Parallel fetching ---
            try {
                const [fbResult, mainSheetResult, hcSheetResult] = await Promise.allSettled([
                    get(child(dbRef, 'predictions')), // Firebase
                    fetch(GOOGLE_SHEET_URL).then(res => res.ok ? res.text() : Promise.reject(`Sheet 1 Error: ${res.status}`)), // Main Sheet
                    fetch(HIGH_CHANCE_SHEET_URL).then(res => res.ok ? res.text() : Promise.reject(`Sheet 2 Error: ${res.status}`)) // HC Sheet
                ]);

                // 1. Process Firebase Data
                setLoadingMessage("Processing Firebase data...");
                firebaseMatchesData = [];
                if (fbResult.status === 'fulfilled' && fbResult.value.exists()) {
                    const fbData = fbResult.value.val();
                    firebaseMatchesData = Object.keys(fbData).map(key => fbData[key]);
                    window.firebaseKeys = new Set(firebaseMatchesData.map(m => m.MatchKey));
                    console.log(`Loaded ${firebaseMatchesData.length} matches from Firebase.`);
                    
                    // REQ 4: Populate Stats Filters
                    const fbLeagues = [...new Set((firebaseMatchesData || []).map(match => match.League))].filter(Boolean).sort();
                    const fbDates = [...new Set((firebaseMatchesData || []).map(match => match.Date))].filter(Boolean).sort().reverse();
                    fillSelect(dom.filters.statsLeague, fbLeagues, "All Leagues");
                    fillSelect(dom.filters.statsDate, fbDates, "All Dates");
                } else if (fbResult.status === 'rejected') {
                    console.error("Firebase Read Error:", fbResult.reason);
                    showNotification("Could not load data from Firebase.", "error");
                }

                // 2. Process Main Google Sheet Data
                setLoadingMessage("Processing All Matches data...");
                googleSheetMatchesData = [];
                if (mainSheetResult.status === 'fulfilled') {
                    const sheetMatchesRaw = parseCSV(mainSheetResult.value);
                    googleSheetMatchesData = sheetMatchesRaw.map(parseMatchObject).filter(m => m.MatchKey);
                    console.log(`Parsed ${googleSheetMatchesData.length} matches from Main Google Sheet.`);
                    populateMainFilters(googleSheetMatchesData); // Populate main filters
                } else {
                    console.error("Main Google Sheet Fetch Error:", mainSheetResult.reason);
                    showNotification("Could not load data from Main Google Sheet.", "error");
                }
                
                // 3. Process High Chance Google Sheet Data
                setLoadingMessage("Processing High Chance data...");
                highChanceSheetData = [];
                if (hcSheetResult.status === 'fulfilled') {
                    const sheetMatchesRaw = parseCSV(hcSheetResult.value);
                    highChanceSheetData = sheetMatchesRaw.map(parseMatchObject).filter(m => m.MatchKey);
                    console.log(`Parsed ${highChanceSheetData.length} matches from High Chance Sheet.`);
                    populateHighChanceFilters(highChanceSheetData); // Populate HC filters
                } else {
                    console.error("High Chance Sheet Fetch Error:", hcSheetResult.reason);
                    showNotification("Could not load data from High Chance Sheet.", "error");
                }

                // 4. Combine lists for lookups
                allMatchesData = [...googleSheetMatchesData, ...firebaseMatchesData, ...highChanceSheetData];
                // De-duplicate based on MatchKey, giving preference to Firebase, then Main, then HC
                const matchMap = new Map();
                highChanceSheetData.forEach(m => matchMap.set(m.MatchKey, m));
                googleSheetMatchesData.forEach(m => matchMap.set(m.MatchKey, m));
                firebaseMatchesData.forEach(m => matchMap.set(m.MatchKey, m));
                allMatchesData = Array.from(matchMap.values());
                
                applyFiltersAndRender();
                if (activeTab === 'statistics') {
                    renderStatistics();
                }

            } catch (error) {
                console.error("Data Fetching Error:", error);
                showNotification("A critical error occurred while fetching data.", "error");
            } finally {
                dom.loadingSpinner.classList.add('hidden');
            }
        }
        
        /**
         * Helper function to populate a <select> element.
         * @param {HTMLElement} el The <select> element.
         * @param {Array<string>} items The array of string items.
         * @param {string} defaultOptionText The text for the default (value="") option.
         */
        function fillSelect(el, items, defaultOptionText = "All") {
            if (!el) return;
            el.innerHTML = `<option value="">${defaultOptionText}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                el.appendChild(option);
            });
        }

        // --- NEW: Split filter population ---
        function populateMainFilters(data) {
            const leagues = [...new Set((data || []).map(match => match.League))].filter(Boolean).sort();
            const dates = [...new Set((data || []).map(match => match.Date))].filter(Boolean).sort().reverse();
            // REQ 3: Populate new dropdowns
            const correctScores = [...new Set((data || []).map(match => match["Correct Score"]))].filter(Boolean).sort();
            const recommendationTips = [...new Set((data || []).map(match => match["Recommendation Tip"]))].filter(Boolean).sort();

            fillSelect(dom.filters.league, leagues, "All Leagues");
            fillSelect(dom.filters.date, dates, "All Dates");
            fillSelect(dom.filters.correctScore, correctScores, "All");
            fillSelect(dom.filters.recommendationTip, recommendationTips, "All");
            
            fillSelect(dom.filters.finished.league, leagues, "All Leagues");
            fillSelect(dom.filters.finished.date, dates, "All Dates");
        }

        function populateHighChanceFilters(data) {
            const leagues = [...new Set((data || []).map(match => match.League))].filter(Boolean).sort();
            const dates = [...new Set((data || []).map(match => match.Date))].filter(Boolean).sort().reverse();
            const correctScores = [...new Set((data || []).map(match => getVal(match, "Correct Score")))].filter(Boolean).sort();
            const confidences = [...new Set((data || []).map(match => getVal(match, "Confidence %")))].filter(Boolean).sort((a,b) => b - a);
            const recommendTips = [...new Set((data || []).map(match => getVal(match, "Recommendation Tip")))].filter(Boolean).sort();

            fillSelect(dom.filters.hc.date, dates, "All Dates");
            fillSelect(dom.filters.hc.league, leagues, "All Leagues");
            fillSelect(dom.filters.hc.correctScore, correctScores, "Any");
            fillSelect(dom.filters.hc.confidence, confidences, "Any");
            fillSelect(dom.filters.hc.recommendTip, recommendTips, "Any");
        }
        // --- End new filter functions ---
        
        function fetchAdminUsers() {
            get(child(dbRef, 'users')).then((snapshot) => {
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    renderUsersTable(users);
                }
            }).catch(error => console.error("Error fetching users:", error));
        }

        // -------------------------------------------
        // SELECTION LOGIC (Save/Load)
        // -------------------------------------------
        
        async function loadUserSelections() {
            if (!currentUser) return;
            setLoadingMessage("Loading saved selections...");
            try {
                const snapshot = await get(child(dbRef, `selections/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const collections = snapshot.val();
                    dom.selections.loadSelect.innerHTML = ''; // Clear existing
                    Object.keys(collections).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dom.selections.loadSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error loading collections:", error);
                showNotification("Could not load saved selections.", "error");
            }
        }
        
        dom.selections.loadSelect.addEventListener('change', async (e) => {
            // This now loads the *first* selected item if in multi-select mode
            const selectedOptions = Array.from(dom.selections.loadSelect.selectedOptions);
            if (selectedOptions.length === 0) return;

            const collectionName = selectedOptions[0].value; // Load the first one
            if (!collectionName || !currentUser) return;
            
            try {
                const snapshot = await get(child(dbRef, `selections/${currentUser.uid}/${collectionName}`));
                if (snapshot.exists()) {
                    const collection = snapshot.val();
                    selections = collection.matches || [];
                    dom.selections.collectionName.value = collection.name;
                    applyFiltersAndRender(); // Re-render all tables to show new selections
                    renderSelectionsTable();
                    showNotification(`Collection "${collectionName}" loaded.`, "success");
                }
            } catch (error) {
                console.error("Error loading collection:", error);
                showNotification("Could not load collection.", "error");
            }
        });
        
        dom.selections.saveBtn.addEventListener('click', async () => {
            const collectionName = dom.selections.collectionName.value;
            if (!collectionName) {
                showNotification("Please enter a name for your collection.", "error");
                return;
            }
            if (selections.length === 0) {
                showNotification("No matches selected to save.", "info");
                return;
            }
            if (!currentUser) {
                showNotification("You must be logged in to save.", "error");
                return;
            }

            const payload = { 
                name: collectionName, 
                matches: selections,
                updatedAt: new Date().toISOString()
            };
            
            try {
                await set(ref(db, `selections/${currentUser.uid}/${collectionName}`), payload);
                showNotification(`Collection "${collectionName}" saved.`, "success");
                await loadUserSelections(); // Refresh dropdown
                dom.selections.loadSelect.value = collectionName;
            } catch (error) {
                console.error("Error saving collection:", error);
                showNotification("Failed to save collection.", "error");
            }
        });

        // REQ 5: Merge Collections
        async function mergeSelectedCollections() {
            const selectedOptions = Array.from(dom.selections.loadSelect.selectedOptions);
            if (selectedOptions.length < 2) {
                showNotification("Please select two or more collections to merge (use Ctrl/Cmd + Click).", "info");
                return;
            }

            let mergedMatchKeys = new Set();
            let mergedNames = [];
            
            setLoadingMessage("Merging collections...");
            dom.loadingSpinner.classList.remove('hidden');

            for (const option of selectedOptions) {
                const collectionName = option.value;
                mergedNames.push(collectionName);
                try {
                    const snapshot = await get(child(dbRef, `selections/${currentUser.uid}/${collectionName}`));
                    if (snapshot.exists()) {
                        (snapshot.val().matches || []).forEach(key => mergedMatchKeys.add(key));
                    }
                } catch (error) {
                    console.error("Error loading collection for merge:", error);
                }
            }

            selections = Array.from(mergedMatchKeys);
            const newCollectionName = `Merged_(${mergedNames.join('+')})`.substring(0, 50);
            dom.selections.collectionName.value = newCollectionName;
            
            dom.loadingSpinner.classList.add('hidden');
            renderSelectionsTable();
            showNotification(`Merged ${selectedOptions.length} collections into a new temporary selection. Save it now if you wish.`, "success");
        }
        dom.selections.mergeBtn.addEventListener('click', mergeSelectedCollections);


        // -------------------------------------------
        // FILTERING LOGIC (UPDATED)
        // -------------------------------------------

        function applyFiltersAndRender() {
            // 1. Get all filter values
            // This function now just *gets* filters. The logic is applied tab-specifically.
            const filters = {
                // Main
                league: dom.filters.league.value,
                date: dom.filters.date.value,
                correctScore: dom.filters.correctScore.value, // REQ 3
                recommendationTip: dom.filters.recommendationTip.value, // REQ 3
                predGoalsMin: parseFloat(dom.filters.predGoalsMin.value) || null,
                predGoalsMax: parseFloat(dom.filters.predGoalsMax.value) || null,
                goalsScoredMin: parseFloat(dom.filters.goalsScoredMin.value) || null,
                goalsScoredMax: parseFloat(dom.filters.goalsScoredMax.value) || null,
                homePowerMin: parseFloat(dom.filters.homePowerMin.value) || null,
                homePowerMax: parseFloat(dom.filters.homePowerMax.value) || null,
                awayPowerMin: parseFloat(dom.filters.awayPowerMin.value) || null,
                awayPowerMax: parseFloat(dom.filters.awayPowerMax.value) || null,
                homeStandingMin: parseFloat(dom.filters.homeStandingMin.value) || null,
                homeStandingMax: parseFloat(dom.filters.homeStandingMax.value) || null,
                awayStandingMin: parseFloat(dom.filters.awayStandingMin.value) || null,
                awayStandingMax: parseFloat(dom.filters.awayStandingMax.value) || null,
                globalSearch: dom.filters.globalSearch.value.toLowerCase(),
                // Modal
                hAvgScoredMin: parseFloat(dom.filters.hAvgScoredMin.value) || null,
                hAvgScoredMax: parseFloat(dom.filters.hAvgScoredMax.value) || null,
                hAvgConcededMin: parseFloat(dom.filters.hAvgConcededMin.value) || null,
                hAvgConcededMax: parseFloat(dom.filters.hAvgConcededMax.value) || null,
                hPowerOv25Min: parseFloat(dom.filters.hPowerOv25Min.value) || null,
                hPowerOv25Max: parseFloat(dom.filters.hPowerOv25Max.value) || null,
                aAvgScoredMin: parseFloat(dom.filters.aAvgScoredMin.value) || null,
                aAvgScoredMax: parseFloat(dom.filters.aAvgScoredMax.value) || null,
                aAvgConcededMin: parseFloat(dom.filters.aAvgConcededMin.value) || null,
                aAvgConcededMax: parseFloat(dom.filters.aAvgConcededMax.value) || null,
                aPowerOv25Min: parseFloat(dom.filters.aPowerOv25Min.value) || null,
                aPowerOv25Max: parseFloat(dom.filters.aPowerOv25Max.value) || null,
                hPowerMin: parseFloat(dom.filters.hPowerMin.value) || null,
                hPowerMax: parseFloat(dom.filters.hPowerMax.value) || null,
                aPowerMin: parseFloat(dom.filters.aPowerMin.value) || null,
                aPowerMax: parseFloat(dom.filters.aPowerMax.value) || null,
                hPowerBttsMin: parseFloat(dom.filters.hPowerBttsMin.value) || null,
                hPowerBttsMax: parseFloat(dom.filters.hPowerBttsMax.value) || null,
                aPowerBttsMin: parseFloat(dom.filters.aPowerBttsMin.value) || null,
                aPowerBttsMax: parseFloat(dom.filters.aPowerBttsMax.value) || null,
            };
            
            // Helper for min/max checks
            const inRange = (val, min, max) => {
                const numVal = parseFloat(val);
                if (val === null || val === undefined || isNaN(numVal)) {
                    return (min === null && max === null); // Pass if no filter, fail if filter
                }
                const minPass = (min === null) || numVal >= min;
                const maxPass = (max === null) || numVal <= max;
                return minPass && maxPass;
            };

            // Helper for text checks
            const textMatch = (val, filter) => {
                if (!filter) return true;
                return (val || '').toLowerCase().includes(filter.toLowerCase());
            }

            // -------------------------------------------
            // DATA SOURCE SELECTION & FILTERING
            // -------------------------------------------
            let sourceData = [];
            filteredMatches = [];
            
            // Hide all pagination
            dom.pagination.container.classList.add('hidden');
            dom.hcPagination.container.classList.add('hidden');
            
            if (activeTab === 'all-matches') {
                sourceData = googleSheetMatchesData;
                filteredMatches = sourceData.filter(match => {
                    if (filters.league && match.League !== filters.league) return false;
                    if (filters.date && match.Date !== filters.date) return false;
                    // REQ 3: Updated filter logic for dropdowns
                    if (filters.correctScore && getVal(match, "Correct Score") !== filters.correctScore) return false;
                    if (filters.recommendationTip && getVal(match, "Recommendation Tip") !== filters.recommendationTip) return false;
                    
                    if (filters.globalSearch) {
                        const search = filters.globalSearch;
                        if (!textMatch(getVal(match, "Home Team"), search) &&
                            !textMatch(getVal(match, "Away Team"), search) &&
                            !textMatch(match.League, search) &&
                            !textMatch(match.Date, search)) return false;
                    }

                    if (!inRange(getVal(match, "Predicted Total Goals"), filters.predGoalsMin, filters.predGoalsMax)) return false;
                    if (!inRange(getVal(match, "Goals to be Scored"), filters.goalsScoredMin, filters.goalsScoredMax)) return false;
                    if (!inRange(getVal(match, "Home Team Power"), filters.homePowerMin, filters.homePowerMax)) return false;
                    if (!inRange(getVal(match, "Away Team Power"), filters.awayPowerMin, filters.awayPowerMax)) return false;
                    if (!inRange(getVal(match, "Home Team Table Standing"), filters.homeStandingMin, filters.homeStandingMax)) return false;
                    if (!inRange(getVal(match, "Away Team Table Standing"), filters.awayStandingMin, filters.awayStandingMax)) return false;
                    
                    // Modal Filters
                    if (!inRange(getVal(match, "Hteam Avg Scored"), filters.hAvgScoredMin, filters.hAvgScoredMax)) return false;
                    if (!inRange(getVal(match, "Hteam Avg Conceded"), filters.hAvgConcededMin, filters.hAvgConcededMax)) return false;
                    if (!inRange(getVal(match, "HTeam Power - Over 2.5"), filters.hPowerOv25Min, filters.hPowerOv25Max)) return false;
                    if (!inRange(getVal(match, "Ateam Avg Scored"), filters.aAvgScoredMin, filters.aAvgScoredMax)) return false;
                    if (!inRange(getVal(match, "Ateam Avg Conceded"), filters.aAvgConcededMin, filters.aAvgConcededMax)) return false;
                    if (!inRange(getVal(match, "ATeam Power - Over 2.5"), filters.aPowerOv25Min, filters.aPowerOv25Max)) return false;
                    if (!inRange(getVal(match, "Home Team Power"), filters.hPowerMin, filters.hPowerMax)) return false;
                    if (!inRange(getVal(match, "Away Team Power"), filters.aPowerMin, filters.aPowerMax)) return false;
                    if (!inRange(getVal(match, "HTeam Power - BTTS"), filters.hPowerBttsMin, filters.hPowerBttsMax)) return false;
                    if (!inRange(getVal(match, "ATeam Power - BTTS"), filters.aPowerBttsMin, filters.aPowerBttsMax)) return false;
                    
                    return true;
                });
                
                renderAllMatchesTable();
                updateSummaryCards('all-matches', filteredMatches);
                dom.pagination.container.classList.remove('hidden');

            } else if (activeTab === 'high-chance') {
                sourceData = highChanceSheetData;
                // Get HC filter values
                const hcFilters = {
                    date: dom.filters.hc.date.value,
                    league: dom.filters.hc.league.value,
                    correctScore: dom.filters.hc.correctScore.value,
                    confidence: dom.filters.hc.confidence.value,
                    recommendTip: dom.filters.hc.recommendTip.value,
                };
                
                filteredMatches = sourceData.filter(m => {
                    // Apply dropdown filters
                    if (hcFilters.date && m.Date !== hcFilters.date) return false;
                    if (hcFilters.league && m.League !== hcFilters.league) return false;
                    if (hcFilters.correctScore && getVal(m, "Correct Score") !== hcFilters.correctScore) return false;
                    if (hcFilters.confidence && getVal(m, "Confidence %") !== hcFilters.confidence) return false;
                    if (hcFilters.recommendTip && getVal(m, "Recommendation Tip") !== hcFilters.recommendTip) return false;

                    // Apply existing logic filter
                    const c = parseFloat(getVal(m, "Confidence %")) || 0;
                    const pp = parseFloat(getVal(m, "Predicted Probability (%)")) || 0;
                    const pr = parseFloat(getVal(m, "Probability Rate")) || 0;
                    return c >= 60 && pp > 50 && pr > 45;
                });
                
                renderHighChanceTable();
                updateSummaryCards('hc', filteredMatches); // REQ 6
                dom.hcPagination.container.classList.remove('hidden');

            } else if (activeTab === 'finished-matches') {
                sourceData = firebaseMatchesData;
                // Get Finished filter values
                const finishedFilters = {
                    league: dom.filters.finished.league.value,
                    date: dom.filters.finished.date.value
                };

                filteredMatches = sourceData.filter(m => {
                    if (finishedFilters.league && m.League !== finishedFilters.league) return false;
                    if (finishedFilters.date && m.Date !== finishedFilters.date) return false;
                    return true;
                });

                renderAllMatchesTable(); // Re-use the main table
                updateSummaryCards('all-matches', filteredMatches); // Re-use main cards
                dom.pagination.container.classList.remove('hidden');

            // NEW: Handle hot-picks tab
            } else if (activeTab === 'hot-picks') {
                // Currently no filtering, just shows the content
                // You could add filtering logic here later if needed
                
            } else if (activeTab === 'selections') {
                renderSelectionsTable(); // Handles its own logic
                
            } else if (activeTab === 'statistics') {
                renderStatistics(); // Handles its own logic
                
            } else if (activeTab === 'admin') {
                // No filtering
            }
        }

        function resetAllFilters() {
            // Main filters
            const mainFilters = document.querySelector("#all-matches-tab .bg-white.rounded-xl.shadow-lg");
            mainFilters.querySelectorAll('input, select').forEach(el => el.value = '');
            // Modal filters
            dom.modals.moreFilters.querySelectorAll('input').forEach(el => el.value = '');
            // Global search
            dom.filters.globalSearch.value = '';
            // HC filters
            Object.values(dom.filters.hc).forEach(el => el.value = '');
            // Finished filters
            dom.filters.finished.league.value = '';
            dom.filters.finished.date.value = '';
            // REQ 4: Stats filters
            dom.filters.statsLeague.value = '';
            dom.filters.statsDate.value = '';
            
            applyFiltersAndRender();
        }

        // -------------------------------------------
        // TABLE & LIST RENDERING (UPDATED)
        // -------------------------------------------

        // Helper to get value securely
        const getVal = (obj, key) => {
            if (!obj) return undefined;
            const sanitizedKey = sanitizeKey(key);
            return obj[key] !== undefined ? obj[key] : obj[sanitizedKey];
        }

        // REQ 6: Helper function for summary cards
        function updateSummaryCards(prefix, data) {
            // Helper to get stats for a specific field
            const getStats = (fieldName) => {
                let total = 0, wins = 0;
                data.forEach(m => {
                    const actual = getMatchOutcome(getVal(m, "Match Result"));
                    let pred = getVal(m, fieldName);
                    if (!actual || !pred || pred === 'N/A' || pred === 'Pending' || pred === '') return;
                    
                    total++;
                    let predOutcome = "Other";
                    if (String(pred).toLowerCase().includes('home')) predOutcome = "Home";
                    else if (String(pred).toLowerCase().includes('draw')) predOutcome = "Draw";
                    else if (String(pred).toLowerCase().includes('away')) predOutcome = "Away";
                    
                    if (predOutcome === actual) wins++;
                });
                return { total, wins };
            };
            
            const predStats = getStats("Prediction");
            const predTotalEl = document.getElementById(`card-${prefix}-pred-total`);
            const predWinsEl = document.getElementById(`card-${prefix}-pred-wins`);
            if (predTotalEl) predTotalEl.textContent = predStats.total;
            if (predWinsEl) predWinsEl.textContent = predStats.wins;
            
            const poStats = getStats("Predicted Outcome");
            const poTotalEl = document.getElementById(`card-${prefix}-po-total`);
            const poWinsEl = document.getElementById(`card-${prefix}-po-wins`);
            if (poTotalEl) poTotalEl.textContent = poStats.total;
            if (poWinsEl) poWinsEl.textContent = poStats.wins;

            const eoStats = getStats("Expected Outcome");
            const eoTotalEl = document.getElementById(`card-${prefix}-eo-total`);
            const eoWinsEl = document.getElementById(`card-${prefix}-eo-wins`);
            if (eoTotalEl) eoTotalEl.textContent = eoStats.total;
            if (eoWinsEl) eoWinsEl.textContent = eoStats.wins;
        }


        function renderAllMatchesTable() {
            const totalMatches = filteredMatches.length;
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalMatches);
            const paginatedMatches = filteredMatches.slice(startIndex, endIndex);

            let tableHtml = '';
            paginatedMatches.forEach(match => {
                tableHtml += createMatchRowHtml(match, 'all-matches');
            });

            // Render to the main table body
            dom.matchesTableBody.innerHTML = tableHtml || `<tr><td colspan="16" class="text-center p-6 text-gray-500">No matches found.</td></tr>`;
            
            // Update main pagination
            dom.pagination.start.textContent = totalMatches > 0 ? startIndex + 1 : 0;
            dom.pagination.end.textContent = endIndex;
            dom.pagination.total.textContent = totalMatches;
            dom.pagination.prev.disabled = (currentPage === 1);
            dom.pagination.next.disabled = (endIndex === totalMatches);
        }

        function renderHighChanceTable() {
            const totalMatches = filteredMatches.length;
            const startIndex = (hcCurrentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalMatches);
            const paginatedMatches = filteredMatches.slice(startIndex, endIndex);

            let tableHtml = '';
            paginatedMatches.forEach(match => {
                tableHtml += createMatchRowHtml(match, 'high-chance');
            });

            // Render to the *high chance* table body
            dom.highChanceTableBody.innerHTML = tableHtml || `<tr><td colspan="9" class="text-center p-6 text-gray-500">No high-chance matches found.</td></tr>`;
        
            // Update high chance pagination
            dom.hcPagination.start.textContent = totalMatches > 0 ? startIndex + 1 : 0;
            dom.hcPagination.end.textContent = endIndex;
            dom.hcPagination.total.textContent = totalMatches;
            dom.hcPagination.prev.disabled = (hcCurrentPage === 1);
            dom.hcPagination.next.disabled = (endIndex === totalMatches);
        }
        
        function renderSelectionsTable() {
            let tableHtml = '';
            // Find full match objects from `allMatchesData` (which has both sources)
            const selectedMatches = selections.map(key => allMatchesData.find(m => m.MatchKey === key)).filter(Boolean); // .filter(Boolean) removes undefined
            
            selectedMatches.forEach(match => {
                const prediction = getVal(match, 'Prediction');
                const isStarred = (prediction && prediction === getVal(match, "Predicted Outcome") && prediction === getVal(match, "Expected Outcome"));
                const rowClass = getRowClass(prediction, getVal(match, "Match Result")); // REQ 2

                tableHtml += `
                    <tr class="hover:bg-gray-50 ${rowClass}">
                        <td class="px-2 py-4 whitespace-nowrap text-sm">${isStarred ? '⭐' : ''}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${match.Date || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Home Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Away Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${prediction || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">${getVal(match, "Confidence %") || 0}%</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${getVal(match, "Match Result") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${calculateTotalGoals(getVal(match, "Match Result"))}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                            <button class="text-red-600 hover:text-red-800 remove-selection-btn" data-match-key="${match.MatchKey}">Delete</button>
                            <button class="text-emerald hover:text-navy view-details-btn" data-match-key="${match.MatchKey}">View</button>
                        </td>
                    </tr>
                `;
            });
            
            dom.selectionsTableBody.innerHTML = tableHtml || `<tr><td colspan="9" class="text-center p-6 text-gray-500">No matches selected.</td></tr>`;

            updateSummaryCards('sel', selectedMatches);
        }
        
        // REQ 2: Conditional Formatting Helper (UPDATED)
        function getRowClass(prediction, result) {
            const actualOutcome = getMatchOutcome(result);
            if (!actualOutcome || !prediction || prediction === 'N/A' || prediction === 'Pending' || prediction === '') {
                return 'row-pending';
            }
            
            // Normalize prediction (e.g., "Home Win" -> "Home")
            let predOutcome = String(prediction).split(' ')[0]; 

            if (predOutcome === actualOutcome) {
                if (actualOutcome === 'Home') return 'row-home-win';
                if (actualOutcome === 'Draw') return 'row-draw-win';
                if (actualOutcome === 'Away') return 'row-away-win';
            }
            
            return 'row-fail';
        }

        function getPercentageClass(value) {
            const val = parseFloat(value);
            if (isNaN(val)) return '';
            if (val >= 60) return 'bg-dark-green text-white';
            if (val > 50) return 'bg-light-green text-black';
            return '';
        }

        // --- UPDATED: createMatchRowHtml (REQ 1 & 2) ---
        function createMatchRowHtml(match, tableType) {
            if (tableType === 'all-matches' || tableType === 'finished-matches') {
                const isSelected = selections.includes(match.MatchKey);
                const prediction = getVal(match, 'Prediction');
                const result = getVal(match, "Match Result");
                const isStarred = (prediction && prediction === getVal(match, "Predicted Outcome") && prediction === getVal(match, "Expected Outcome"));
                
                // REQ 2: Use updated getRowClass for all logic
                const rowClass = getRowClass(prediction, result);
                
                const odds = `${getVal(match, "Home Odds") || 'N/A'} / ${getVal(match, "Draw Odds") || 'N/A'} / ${getVal(match, "Away Odds") || 'N/A'}`;
                
                return `
                    <tr class="${rowClass} hover:bg-gray-100">
                        <td class="px-2 py-4 whitespace-nowrap"><input type="checkbox" class="rounded text-emerald focus:ring-emerald select-match-checkbox" data-match-key="${match.MatchKey}" ${isSelected ? 'checked' : ''}></td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm">${isStarred ? '⭐' : ''}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${match.Date || 'N/A'}</td>
                        <!-- REQ 1: Actions Moved -->
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-emerald hover:text-navy view-details-btn" data-match-key="${match.MatchKey}">View</button>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Home Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Away Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${odds}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Correct Score") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${prediction || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">${getVal(match, "Confidence %") || 'N/A'}%</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Predicted Outcome") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Predicted Probability (%)") || 'N/A'}%</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Expected Outcome") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Probability Rate") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${result || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${calculateTotalGoals(result)}</td>
                    </tr>
                `;

            } else if (tableType === 'high-chance') {
                const result = getVal(match, "Match Result");
                const prediction = getVal(match, 'Prediction');
                // REQ 2: Use updated getRowClass
                const rowClass = getRowClass(prediction, result);

                return `
                    <tr class="${rowClass} hover:bg-gray-100">
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${match.Date || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Home Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getVal(match, "Away Team") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${getVal(match, "Home Odds") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${getVal(match, "Draw Odds") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${getVal(match, "Away Odds") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${result || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Predicted Outcome") || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${getVal(match, "Expected Outcome") || 'N/A'}</td>
                    </tr>
                `;
            }
            return ''; // Default case
        }
        
        function renderUsersTable(users) {
            let tableHtml = '';
            Object.keys(users).forEach(uid => {
                const user = users[uid];
                const isCurrentUser = (currentUser && currentUser.uid === uid);
                
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${user.email}</div>
                            <div class="text-sm text-gray-500">${user.fullName || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select data-user-id="${uid}" class="role-select rounded-lg border-gray-300 focus:ring-emerald focus:border-emerald" ${isCurrentUser ? 'disabled' : ''}>
                                <option value="Standard User" ${user.role === 'Standard User' ? 'selected' : ''}>Standard User</option>
                                <option value="Analyst" ${user.role === 'Analyst' ? 'selected' : ''}>Analyst</option>
                                <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${user.status === 'Active' || user.status === undefined ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${user.status || 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                            <button data-user-id="${uid}" class="save-user-btn text-emerald hover:text-navy" ${isCurrentUser ? 'disabled' : ''}>Save</button>
                            <button data-user-id="${uid}" class="deactivate-user-btn text-red-600 hover:text-red-900" ${isCurrentUser ? 'disabled' : ''}>Deactivate</button>
                        </td>
                    </tr>
                `;
            });
            dom.usersTableBody.innerHTML = tableHtml;
        }

        // -------------------------------------------
        // STATISTICS & CHARTS (REBUILT)
        // -------------------------------------------

        function renderStatistics() {
            // Re-acquire chart contexts
            const chartCtx = {
                prediction: document.getElementById('chart-prediction')?.getContext('2d'),
                predictedOutcome: document.getElementById('chart-predicted-outcome')?.getContext('2d'),
                expectedOutcome: document.getElementById('chart-expected-outcome')?.getContext('2d'),
            };

            // UPDATED: Stats are based on Firebase data only
            if (!chartCtx.prediction || !chartCtx.predictedOutcome || !chartCtx.expectedOutcome ) {
                console.warn("Charts context not found.");
                if (charts.prediction) charts.prediction.destroy();
                if (charts.predictedOutcome) charts.predictedOutcome.destroy();
                if (charts.expectedOutcome) charts.expectedOutcome.destroy();
                return;
            }

            // REQ 4: Filter data based on stats dropdowns
            const leagueFilter = dom.filters.statsLeague?.value || '';
            const dateFilter = dom.filters.statsDate?.value || '';

            const filteredStatsData = firebaseMatchesData.filter(m => {
                if (leagueFilter && m.League !== leagueFilter) return false;
                if (dateFilter && m.Date !== dateFilter) return false;
                return true;
            });
            
            // Helper function to process stats for one prediction field
            const getStatsForField = (fieldName, data) => {
                let stats = {
                    Home: { total: 0, wins: 0 },
                    Draw: { total: 0, wins: 0 },
                    Away: { total: 0, wins: 0 },
                    Other: { total: 0, wins: 0 },
                    totalWins: 0,
                    totalCount: 0
                };
                
                // UPDATED: Use filtered data
                data.forEach(match => {
                    const actualOutcome = getMatchOutcome(getVal(match, "Match Result"));
                    let prediction = getVal(match, fieldName);
                    
                    if (!actualOutcome || !prediction || prediction === 'N/A' || prediction === 'Pending' || prediction === '') {
                        return; // Skip matches without result or prediction
                    }

                    stats.totalCount++;
                    
                    // Normalize prediction
                    let predOutcome = "Other";
                    if (String(prediction).toLowerCase().includes('home')) predOutcome = "Home";
                    else if (String(prediction).toLowerCase().includes('draw')) predOutcome = "Draw";
                    else if (String(prediction).toLowerCase().includes('away')) predOutcome = "Away";

                    stats[predOutcome].total++;
                    
                    if (predOutcome === actualOutcome) {
                        stats[predOutcome].wins++;
                        stats.totalWins++;
                    }
                });
                return stats;
            };

            // 1. Get stats for "Prediction" field for the main cards
            const mainStats = getStatsForField("Prediction", filteredStatsData);
            const winRate = mainStats.totalCount > 0 ? (mainStats.totalWins / mainStats.totalCount * 100) : 0;
            
            dom.stats.totalPredictions.textContent = mainStats.totalCount;
            dom.stats.totalWins.textContent = mainStats.totalWins;
            dom.stats.winRate.textContent = `${winRate.toFixed(1)}%`;

            // Update new overall summary cards (these are not filtered)
            const totalMatchesCount = allMatchesData.length; // Use the de-duplicated map size
            
            // REQ 3: Only total matches card is shown
            document.getElementById('card-total-matches') && (document.getElementById('card-total-matches').textContent = totalMatchesCount);


            // 2. Create helper to render charts
            const renderBarChart = (ctx, chartInstance, fieldName) => {
                const stats = getStatsForField(fieldName, filteredStatsData);
                const labels = ["Home", "Draw", "Away", "Other"];
                const totalData = labels.map(l => stats[l].total);
                const winsData = labels.map(l => stats[l].wins);

                if (chartInstance) chartInstance.destroy();
                
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Predictions',
                                data: totalData,
                                backgroundColor: 'rgba(0, 31, 63, 0.6)', // Navy
                                borderColor: 'rgba(0, 31, 63, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Total Wins',
                                data: winsData,
                                backgroundColor: 'rgba(0, 168, 107, 0.6)', // Emerald
                                borderColor: 'rgba(0, 168, 107, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            // 3. Render all 3 charts
            charts.prediction = renderBarChart(chartCtx.prediction, charts.prediction, "Prediction");
            charts.predictedOutcome = renderBarChart(chartCtx.predictedOutcome, charts.predictedOutcome, "Predicted Outcome");
            charts.expectedOutcome = renderBarChart(chartCtx.expectedOutcome, charts.expectedOutcome, "Expected Outcome");
        }

        // -------------------------------------------
        // MODAL LOGIC (UPDATED)
        // -------------------------------------------
        
        function openModal(modal) {
            modal.classList.remove('hidden');
        }
        
        function closeModal(modal) {
            modal.classList.add('hidden');
        }
        
        function openMatchDetailsModal(matchKey) {
            // UPDATED: Search the combined allMatchesData
            const match = allMatchesData.find(m => m.MatchKey === matchKey);
            if (!match) {
                showNotification("Error: Could not find match details.", "error");
                return;
            }
            
            dom.modals.matchTitle.textContent = `${getVal(match, "Home Team")} vs ${getVal(match, "Away Team")}`;
            dom.modals.homeTeam.textContent = getVal(match, "Home Team");
            dom.modals.awayTeam.textContent = getVal(match, "Away Team");
            
            // REQ 1 & 3: Define metrics to show as per spec
            const metrics = [
                { label: 'Match Result', homeKey: 'Home FT', awayKey: 'Away FT', bold: true },
                // REQ 1: Add new fields with icons
                { label: '<i class="fa-solid fa-ranking-star w-5 text-center"></i> Home Team Table Standing', homeKey: 'Home Team Table Standing', awayKey: 'Away Team Table Standing' },
                { label: '<i class="fa-solid fa-bolt w-5 text-center"></i> Home Team Power', homeKey: 'Home Team Power', awayKey: 'Away Team Power' },
                // REQ 3: Add Home Win, Draw, Away Win here
                { label: 'Home Win %', singleKey: 'Home Win' },
                { label: 'Draw %', singleKey: 'Draw' },
                { label: 'Away Win %', singleKey: 'Away Win' },
                { label: 'Home Form', homeKey: 'Home Form', awayKey: 'Away Form' },
                { label: 'Form Rate', homeKey: 'Home Form Rate', awayKey: 'Away Form Rate' },
                { label: 'L5 Home/Away Wins', homeKey: 'L5 H-Team Home W', awayKey: 'L5 A-Team Away W' },
                { label: 'Avg Scored', homeKey: 'Hteam Avg Scored', awayKey: 'Ateam Avg Scored' },
                { label: 'Avg Conceded', homeKey: 'Hteam Avg Conceded', awayKey: 'Ateam Avg Conceded' },
                { label: '% OV1.5', homeKey: 'HTeam % -OV1.5', awayKey: 'ATeam % -OV1.5' },
                { label: '% OV2.5', homeKey: 'HTeam % -OV2.5', awayKey: 'ATeam % -OV2.5' },
                { label: '% OV3.5', homeKey: 'HTeam % -OV3.5', awayKey: 'ATeam % -OV3.5' },
                { label: 'Power - Over 2.5', homeKey: 'HTeam Power - Over 2.5', awayKey: 'ATeam Power - Over 2.5' },
                { label: 'Power - BTTS', homeKey: 'HTeam Power - BTTS', awayKey: 'ATeam Power - BTTS' },
                { label: 'Confidence %', singleKey: 'Confidence %' },
                { label: 'Correct Score', singleKey: 'Correct Score' },
                { label: 'Match URL', singleKey: 'Match URL' },
            ];
            
            let tableHtml = '';
            metrics.forEach(metric => {
                let homeVal = 'N/A';
                let awayVal = 'N/A';
                let isSingle = false;
                
                // REQ 1: Handle icons in labels
                let labelHtml = metric.label;
                if (metric.label.includes('Home Team Table Standing')) {
                     labelHtml = `<span class="flex items-center gap-x-2"><i class="fa-solid fa-ranking-star w-5 text-center text-blue-500"></i> Home Team Table Standing</span>`;
                     awayVal = getVal(match, metric.awayKey) !== null ? getVal(match, metric.awayKey) : 'N/A';
                     homeVal = getVal(match, metric.homeKey) !== null ? getVal(match, metric.homeKey) : 'N/A';
                } else if (metric.label.includes('Home Team Power')) {
                    labelHtml = `<span class="flex items-center gap-x-2"><i class="fa-solid fa-bolt w-5 text-center text-yellow-500"></i> Home Team Power</span>`;
                    awayVal = getVal(match, metric.awayKey) !== null ? getVal(match, metric.awayKey) : 'N/A';
                    homeVal = getVal(match, metric.homeKey) !== null ? getVal(match, metric.homeKey) : 'N/A';
                }
                // Handle split labels for Home/Away (REQ 1 logic)
                else if (metric.homeKey && metric.awayKey) {
                    homeVal = getVal(match, metric.homeKey) !== null ? getVal(match, metric.homeKey) : 'N/A';
                    awayVal = getVal(match, metric.awayKey) !== null ? getVal(match, metric.awayKey) : 'N/A';
                }
                // Handle singleKey fields
                else if (metric.singleKey) {
                    isSingle = true;
                    homeVal = getVal(match, metric.singleKey) !== null ? getVal(match, metric.singleKey) : 'N/A';
                    if (metric.label === 'Match URL' && homeVal !== 'N/A' && homeVal) {
                        homeVal = `<a href="${homeVal}" target="_blank" class="text-blue-600 hover:underline">View Match</a>`;
                    }
                }
                
                const boldClass = metric.bold ? 'font-bold text-lg text-navy' : 'text-gray-600';
                
                if (isSingle) {
                     tableHtml += `
                        <tr class="${metric.bold ? 'font-semibold' : ''}">
                            <td class="px-4 py-3 text-sm ${metric.bold ? 'text-gray-900' : 'text-gray-700'}">${labelHtml}</td>
                            <td colspan="2" class="px-4 py-3 text-center text-sm ${boldClass}">${homeVal}</td>
                        </tr>
                    `;
                } else {
                    // REQ 1: Logic to customize Away label for new fields
                    let awayLabelHtml = '';
                    if (metric.label.includes('Home Team Table Standing')) {
                        awayLabelHtml = `<span class="flex items-center gap-x-2"><i class="fa-solid fa-flag-checkered w-5 text-center text-green-500"></i> Away Team Table Standing</span>`;
                    } else if (metric.label.includes('Home Team Power')) {
                        awayLabelHtml = `<span class="flex items-center gap-x-2"><i class="fa-solid fa-fire w-5 text-center text-red-500"></i> Away Team Power</span>`;
                    }
                    
                    if (awayLabelHtml) {
                        // Render as two separate rows for the side-by-side request
                        tableHtml += `
                        <tr class="${metric.bold ? 'font-semibold' : ''}">
                            <td class="px-4 py-3 text-sm ${metric.bold ? 'text-gray-900' : 'text-gray-700'}">${labelHtml}</td>
                            <td colspan="2" class="px-4 py-3 text-center text-sm ${boldClass}">${homeVal}</td>
                        </tr>
                        <tr class="${metric.bold ? 'font-semibold' : ''}">
                            <td class="px-4 py-3 text-sm ${metric.bold ? 'text-gray-900' : 'text-gray-700'}">${awayLabelHtml}</td>
                            <td colspan="2" class="px-4 py-3 text-center text-sm ${boldClass}">${awayVal}</td>
                        </tr>
                        `;
                    } else {
                        // Original render logic
                        tableHtml += `
                            <tr class="${metric.bold ? 'font-semibold' : ''}">
                                <td class="px-4 py-3 text-sm ${metric.bold ? 'text-gray-900' : 'text-gray-700'}">${labelHtml}</td>
                                <td class="px-4 py-3 text-center text-sm ${boldClass}">${homeVal}</td>
                                <td class="px-4 py-3 text-center text-sm ${boldClass}">${awayVal}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            dom.modals.comparisonTable.innerHTML = tableHtml;
            openModal(dom.modals.matchDetails);
        }

        // -------------------------------------------
        // EVENT LISTENERS
        // -------------------------------------------
        
        // Filter Buttons
        dom.filterButtons.moreFilters.addEventListener('click', () => openModal(dom.modals.moreFilters));
        dom.filterButtons.closeMoreFilters.addEventListener('click', () => closeModal(dom.modals.moreFilters));
        dom.filterButtons.applyMain.addEventListener('click', applyFiltersAndRender);
        dom.filterButtons.applyModal.addEventListener('click', () => {
            applyFiltersAndRender();
            closeModal(dom.modals.moreFilters);
        });
        dom.filterButtons.resetMain.addEventListener('click', resetAllFilters);
        dom.filterButtons.resetModal.addEventListener('click', () => {
             dom.modals.moreFilters.querySelectorAll('input').forEach(el => el.value = '');
             // Need to also reset the modal-mirror filters in the main section
             dom.filters.hPowerMin.value = ''; dom.filters.hPowerMax.value = '';
             dom.filters.aPowerMin.value = ''; dom.filters.aPowerMax.value = '';
             applyFiltersAndRender();
        });
        dom.filters.globalSearch.addEventListener('input', applyFiltersAndRender);
        
        // Add listeners for HC filters to re-render
        Object.values(dom.filters.hc).forEach(el => {
            el.addEventListener('change', applyFiltersAndRender);
        });
        
        // Add listeners for Finished filters to re-render
        dom.filters.finished.apply.addEventListener('click', applyFiltersAndRender);

        // REQ 4: Add listeners for Stats filters
        dom.filters.statsLeague.addEventListener('change', renderStatistics);
        dom.filters.statsDate.addEventListener('change', renderStatistics);

        // Manual Push to Firebase
        dom.filterButtons.refreshData.addEventListener('click', async () => {
            setLoadingMessage('Refreshing data...');
            dom.loadingSpinner.classList.remove('hidden');
            try {
                await fetchMatchData();
                showNotification('Data refreshed.', 'success');
            } catch (err) {
                console.error('Refresh failed:', err);
                showNotification('Failed to refresh data.', 'error');
            } finally {
                dom.loadingSpinner.classList.add('hidden');
            }
        });

        dom.filterButtons.pushToFirebase.addEventListener('click', async () => {
            if (selections.length === 0) {
                showNotification("No matches selected to push.", "info");
                return;
            }
            
            setLoadingMessage(`Pushing ${selections.length} matches to Firebase...`);
            dom.loadingSpinner.classList.remove('hidden');
            
            let successCount = 0;
            const pushPromises = selections.map(async (matchKey) => {
                // UPDATED: Search the combined allMatchesData
                const match = allMatchesData.find(m => m.MatchKey === matchKey);
                if (match) {
                    try {
                        match.Staged = true; // Mark as manually staged
                        const safeKey = sanitizeKey(match.MatchKey); 
                        if (!safeKey) {
                            console.warn("Skipping push for match with invalid key:", match.MatchKey);
                            return; // Skip this one
                        }
                        const safeMatchData = sanitizeObject(match);
                        await set(ref(db, 'predictions/' + safeKey), safeMatchData); 
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to push ${matchKey}:`, error);
                    }
                }
            });
            
            await Promise.all(pushPromises);
            
            dom.loadingSpinner.classList.add('hidden');
            showNotification(`Successfully pushed ${successCount} out of ${selections.length} matches.`, "success");
            
            // Clear selections after pushing
            selections = [];
            // Refresh data to reflect changes
            await fetchMatchData();
        });

        // Pagination
        dom.pagination.prev.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                if(activeTab === 'all-matches' || activeTab === 'finished-matches') renderAllMatchesTable();
            }
        });
        dom.pagination.next.addEventListener('click', () => {
            const totalMatches = filteredMatches.length;
            if (currentPage * rowsPerPage < totalMatches) {
                currentPage++;
                if(activeTab === 'all-matches' || activeTab === 'finished-matches') renderAllMatchesTable();
            }
        });
        
        // High Chance Pagination
        dom.hcPagination.prev.addEventListener('click', () => {
            if (hcCurrentPage > 1) {
                hcCurrentPage--;
                renderHighChanceTable();
            }
        });
        dom.hcPagination.next.addEventListener('click', () => {
            const totalMatches = filteredMatches.length; // 'filteredMatches' is already HC-filtered here
            if (hcCurrentPage * rowsPerPage < totalMatches) {
                hcCurrentPage++;
                renderHighChanceTable();
            }
        });
        
        // Dynamic Table Clicks (using event delegation on parent)
        document.getElementById('dashboard-page').addEventListener('click', (e) => {
            // View Details Button
            const viewBtn = e.target.closest('.view-details-btn');
            if (viewBtn) {
                openMatchDetailsModal(viewBtn.dataset.matchKey);
                return;
            }
            
            // Select Checkbox
            const selectBox = e.target.closest('.select-match-checkbox');
            if (selectBox) {
                toggleSelection(selectBox.dataset.matchKey, selectBox.checked);
                return;
            }

            // Remove from Selections Button
            const removeBtn = e.target.closest('.remove-selection-btn');
            if (removeBtn) {
                toggleSelection(removeBtn.dataset.matchKey, false);
                return;
            }

            // Admin: Save User Role
            const saveBtn = e.target.closest('.save-user-btn');
            if (saveBtn) {
                const userId = saveBtn.dataset.userId;
                const roleSelect = document.querySelector(`.role-select[data-user-id="${userId}"]`);
                if (roleSelect) {
                    updateUserRole(userId, roleSelect.value);
                }
                return;
            }

            // Admin: Deactivate User
            const deactivateBtn = e.target.closest('.deactivate-user-btn');
            if(deactivateBtn) {
                // Placeholder: In a real app, this would be a complex action
                showNotification("Deactivation logic not implemented.", "info");
                return;
            }
        });
        
        // Close Modals
        dom.modals.closeMatchDetails.addEventListener('click', () => closeModal(dom.modals.matchDetails));
        
        // Selections Export
        dom.selections.exportCsv.addEventListener('click', exportSelectionsToCSV);

        // -------------------------------------------
        // HELPER FUNCTIONS
        // -------------------------------------------
        
        function getFriendlyAuthError(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Invalid email or password.';
                case 'auth/email-already-in-use':
                    return 'This email address is already in use.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                default:
                    return 'An unknown error occurred. Please try again.';
            }
        }
        
        function toggleSelection(matchKey, isSelected) {
            if (isSelected) {
                if (!selections.includes(matchKey)) {
                    selections.push(matchKey);
                }
            } else {
                selections = selections.filter(id => id !== matchKey);
            }
            
            // Re-render relevant tables
            if (activeTab === 'all-matches' || activeTab === 'finished-matches') {
                // Find the checkbox and update its state (no full re-render needed)
                const checkbox = document.querySelector(`.select-match-checkbox[data-match-key="${matchKey}"]`);
                if (checkbox) checkbox.checked = isSelected;
            } else if (activeTab === 'selections') {
                renderSelectionsTable(); // Re-render selections list
            }
        }
        
        function updateUserRole(userId, newRole) {
            set(ref(db, `users/${userId}/role`), newRole)
                .then(() => {
                    showNotification(`User role updated to ${newRole}`, "success");
                })
                .catch(error => {
                    console.error("Failed to update user role:", error);
                    showNotification("Failed to update user role.", "error");
                });
        }
        
        function exportSelectionsToCSV() {
            const selectedMatches = selections.map(key => allMatchesData.find(m => m.MatchKey === key)).filter(Boolean);
            if (selectedMatches.length === 0) {
                showNotification("No matches selected to export.", "info");
                return;
            }
            
            const headers = [
                "Date", "Home Team", "Away Team", "Home Odds", "Draw Odds", "Away Odds",
                "Correct Score", "Prediction", "Confidence %", "Predicted Outcome",
                "Predicted Probability (%)", "Expected Outcome", "Probability Rate", "Match Result",
                "Total Goals", "MatchKey"
            ];
            
            const rows = selectedMatches.map(m => {
                const rowData = {
                    ...m,
                    "Total Goals": calculateTotalGoals(getVal(m, "Match Result"))
                };
                return headers.map(header => `"${getVal(rowData, header) || ''}"`).join(',');
            });
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(',') + "\n" 
                + rows.join("\n");
                
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `DataCompass_Selections_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    
        /* ======= Sanitization and Safe Firebase Write ======= */

        /**
         * Recursively sanitizes object keys for Firebase.
         * @param {object} obj - The object to sanitize.
         * @returns {object} A new object with sanitized keys.
         */
        function sanitizeObject(obj) {
          if (!obj) return obj;
          const cleanObj = {};
          for (const [key, value] of Object.entries(obj)) {
            const cleanKey = sanitizeKey(key);
            if (!cleanKey) continue;
            if (value && typeof value === "object" && !Array.isArray(value)) {
              cleanObj[cleanKey] = sanitizeObject(value);
            } else {
              cleanObj[cleanKey] = value;
            }
          }
          return cleanObj;
        }

        /**
         * Sanitizes a string to be used as a Firebase key.
         * @param {string} key - The string to sanitize.
         * @returns {string|null} A sanitized key or null if input is invalid.
         */
        function sanitizeKey(key) {
          if (!key || typeof key !== "string") return null;
          // Replace Firebase forbidden characters and spaces
          return key.replace(/[.#$[\]/%]/g, "_").replace(/\s+/g, "_");
        }


    </script>

</body>
</html>
