<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCompass 360 - App</title>
    
    <!-- Favicon Placeholder -->
    <link rel="icon" href="https://icon.horse/icon/compass.com" type="image/png">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 3. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- 4. Papa Parse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --color-navy: #1E293B; /* Slate 800 */
            --color-emerald: #10B981; /* Emerald 500 */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F8F8F8;
        }
        .bg-navy { background-color: var(--color-navy); }
        .text-navy { color: var(--color-navy); }
        .bg-emerald { background-color: var(--color-emerald); }
        .focus\:border-emerald:focus { border-color: var(--color-emerald); }
        .focus\:ring-emerald:focus { --tw-ring-color: var(--color-emerald); }
        .nav-tab-button.active {
            background-color: #ffffff;
            color: var(--color-navy);
            font-weight: 600;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Notification Toast -->
    <div id="notification-popup" class="fixed top-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 hidden">
        <p id="notification-message"></p>
    </div>

    <div class="flex flex-col h-full">
        <!-- Header -->
        <header class="bg-navy text-white shadow-lg p-4 flex justify-between items-center flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fas fa-compass mr-3 text-emerald-300"></i>
                DataCompass 360
            </h1>
            <span class="text-sm font-light">Email Automation & Analytics Dashboard</span>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Navigation Sidebar -->
            <nav class="w-64 bg-navy text-gray-300 flex-shrink-0 p-4 space-y-2 overflow-y-auto">
                
                <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3 mt-1">Modules</h3>

                <!-- Hot Picks Tab Button -->
                <button data-tab="hot-picks" class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 active transition duration-200">
                    <i class="fas fa-fire-alt h-5 w-5"></i>
                    <span>Hot Picks (Analytics)</span>
                </button>

                <!-- Senders Tab Button -->
                <button data-tab="senders" class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200">
                    <i class="fas fa-envelope-open-text h-5 w-5"></i>
                    <span>Email Senders</span>
                </button>

                <!-- Scheduled Tab Button -->
                <button data-tab="scheduled" class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200">
                    <i class="fas fa-clock h-5 w-5"></i>
                    <span>Scheduled Jobs</span>
                </button>

                <!-- Design Report Tab Button -->
                <button data-tab="design-report" class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200">
                    <i class="fas fa-chart-line h-5 w-5"></i>
                    <span>Report Designer</span>
                </button>
                
                <!-- NEW "Send Email" Tab Button -->
                <button class="nav-tab-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition duration-200" data-tab="send-email">
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 4h16v16H4z" />
                    <path d="M22 6l-10 7L2 6" />
                  </svg>
                  <span>Send Email</span>
                </button>
            </nav>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-100 p-6">
                
                <!-- 
                  =======================
                  TAB: Hot Picks (Analytics)
                  ======================= 
                -->
                <div id="hot-picks-tab" class="tab-content">
                    <h2 class="text-3xl font-bold text-navy mb-6">🔥 Hot Picks: Predictive Analytics</h2>
                    <p class="mb-4 text-gray-600">Identifying high-confidence matches based on historical performance data.</p>
                    
                    <!-- Table 1: Frequent Winners -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-navy">Frequent Winner Teams</h3>
                            <div class="flex space-x-2">
                                <select id="date-filter-1" class="border rounded-lg p-2 text-sm">
                                    <option value="">All Dates</option>
                                </select>
                                <select id="league-filter-1" class="border rounded-lg p-2 text-sm">
                                    <option value="">All Leagues</option>
                                </select>
                            </div>
                        </div>

                        <!-- Loader -->
                        <div id="table-1-loader" class="text-center py-10">
                            <i class="fas fa-spinner fa-spin text-4xl text-emerald"></i>
                            <p class="mt-2 text-gray-500">Loading data from Google Sheet...</p>
                        </div>
                        
                        <!-- Table Content -->
                        <div id="table-1-wrapper" class="overflow-x-auto hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conf %</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prediction</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predicted Outcome</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predicted Prob</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Probability</th>
                                    </tr>
                                </thead>
                                <tbody id="frequent-winners-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JavaScript -->
                                </tbody>
                            </table>
                            
                            <!-- Pagination -->
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-btn-1" class="px-3 py-1 bg-gray-200 rounded-lg text-sm disabled:opacity-50" disabled>Previous</button>
                                <span id="page-info-1" class="text-sm text-gray-600">Page 1 of 1</span>
                                <button id="next-btn-1" class="px-3 py-1 bg-gray-200 rounded-lg text-sm disabled:opacity-50" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table 2: Over 2.5 Goals Prediction -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-navy">Over 2.5 Goals Prediction</h3>
                            <div class="flex space-x-2">
                                <select id="date-filter-2" class="border rounded-lg p-2 text-sm">
                                    <option value="">All Dates</option>
                                </select>
                                <select id="league-filter-2" class="border rounded-lg p-2 text-sm">
                                    <option value="">All Leagues</option>
                                </select>
                            </div>
                        </div>

                        <!-- Loader -->
                        <div id="table-2-loader" class="text-center py-10">
                            <i class="fas fa-spinner fa-spin text-4xl text-emerald"></i>
                            <p class="mt-2 text-gray-500">Analyzing goal trends...</p>
                        </div>

                        <!-- Table Content -->
                        <div id="table-2-wrapper" class="overflow-x-auto hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th colspan="4" class="text-center py-2 text-xs font-bold text-gray-700 bg-gray-100">Average Goals</th>
                                        <th colspan="6" class="text-center py-2 text-xs font-bold text-gray-700 bg-gray-100">Prediction Details</th>
                                        <th colspan="4" class="text-center py-2 text-xs font-bold text-gray-700 bg-gray-100">Actual Outcome</th>
                                    </tr>
                                    <tr>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H Scored</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H Conc.</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A Scored</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A Conc.</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Home Team</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Away Team</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conf %</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prediction</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Outcome</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Prob</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prob</th>
                                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Goals</th>
                                    </tr>
                                </thead>
                                <tbody id="over-2-5-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JavaScript -->
                                </tbody>
                            </table>

                            <!-- Pagination -->
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-btn-2" class="px-3 py-1 bg-gray-200 rounded-lg text-sm disabled:opacity-50" disabled>Previous</button>
                                <span id="page-info-2" class="text-sm text-gray-600">Page 1 of 1</span>
                                <button id="next-btn-2" class="px-3 py-1 bg-gray-200 rounded-lg text-sm disabled:opacity-50" disabled>Next</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 
                  =======================
                  TAB: Email Senders
                  ======================= 
                -->
                <div id="senders-tab" class="tab-content hidden">
                    <h2 class="text-3xl font-bold text-navy mb-6">⚙️ Email Sender Configurations</h2>
                    <div class="flex justify-end mb-4">
                        <button id="add-email-btn" class="px-4 py-2 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium">
                            <i class="fas fa-plus mr-2"></i>Add New Sender
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email Address</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Display Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Auth Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="senders-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Senders populated by Firebase Listener -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Scheduled Jobs
                  ======================= 
                -->
                <div id="scheduled-tab" class="tab-content hidden">
                    <h2 class="text-3xl font-bold text-navy mb-6">⏰ Scheduled Email Jobs</h2>
                    <div class="flex justify-end mb-4">
                        <button id="schedule-email-btn" class="px-4 py-2 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium">
                            <i class="fas fa-calendar-plus mr-2"></i>Schedule New Email
                        </button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recipients</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduling-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Scheduled Jobs populated by Firebase Listener -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  =======================
                  TAB: Design Report
                  ======================= 
                -->
                <div id="design-report-tab" class="tab-content hidden">
                    <h2 class="text-3xl font-bold text-navy mb-6">📊 Design & Schedule Report</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-sm text-gray-600 mb-4">Select analytics criteria and schedule the automated delivery of a customized report.</p>
                        <form id="design-report-form" class="space-y-6">
                            
                            <!-- Report Details -->
                            <div>
                                <h3 class="text-lg font-semibold text-navy mb-2">Report Delivery</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="report-sender" class="block text-sm font-medium text-gray-700">Sender Account</label>
                                        <select id="report-sender" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                            <option value="">No senders available</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="report-email-recipients" class="block text-sm font-medium text-gray-700">Recipient Emails (comma-separated)</label>
                                        <input type="text" id="report-email-recipients" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="user1@example.com, user2@example.com">
                                    </div>
                                    <div>
                                        <label for="report-name" class="block text-sm font-medium text-gray-700">Report Subject/Name</label>
                                        <input type="text" id="report-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="Weekly Hot Picks Summary">
                                    </div>
                                    <div>
                                        <label for="report-recurrence" class="block text-sm font-medium text-gray-700">Delivery Schedule</label>
                                        <select id="report-recurrence" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="one-off">One-off</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label for="report-body" class="block text-sm font-medium text-gray-700">Email Introduction Text</label>
                                    <textarea id="report-body" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald h-20" placeholder="Hi team, here is the latest report..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Report Criteria -->
                            <div>
                                <h3 class="text-lg font-semibold text-navy mb-2">Report Content Filters</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="report-league" class="block text-sm font-medium text-gray-700">Filter by League</label>
                                        <select id="report-league" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                            <option value="">All Leagues (No Filter)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="report-confidence" class="block text-sm font-medium text-gray-700">Minimum Confidence %</label>
                                        <input type="number" id="report-confidence" min="0" max="100" value="75" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                    </div>
                                </div>
                            </div>

                            <!-- Report Fields -->
                            <div>
                                <h3 class="text-lg font-semibold text-navy mb-2">Data Fields to Include</h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="report_field" value="frequent_winners" checked>
                                        <span>Frequent Winner Teams</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="report_field" value="over_2_5_goals" checked>
                                        <span>Over 2.5 Goals Picks</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="report_field" value="match_result">
                                        <span>Match Results</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="report_field" value="probabilities">
                                        <span>Prediction Probabilities</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="report_field" value="team_averages">
                                        <span>Team Averages (Scored/Conc.)</span>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="w-full px-4 py-3 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium text-lg">
                                <i class="fas fa-calendar-check mr-2"></i>Schedule Report Generation Job
                            </button>
                        </form>
                    </div>
                </div>


                <!-- 
                  =======================
                  TAB: Send Email (NEW)
                  ======================= 
                -->
                <div id="send-email-tab" class="tab-content hidden">
                  <h2 class="text-3xl font-bold text-navy mb-6">📧 Send Manual Email</h2>
                  <div class="bg-white rounded-xl shadow-lg p-6">
                    <p class="text-sm text-gray-600 mb-4">This form will add an email request to the <code class="text-sm bg-gray-200 p-1 rounded">/emails/queue/</code> path in Firebase. Your backend Cloud Function is responsible for sending it.</p>
                    <form id="sendEmailForm" class="space-y-4">
                      <div>
                        <label for="recipient" class="block text-sm font-medium text-gray-700">Recipient Email:</label>
                        <input type="email" id="recipient" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="e.g. example@gmail.com">
                      </div>

                      <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700">Subject:</label>
                        <input type="text" id="subject" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="Subject line">
                      </div>

                      <div>
                        <label for="message" class="block text-sm font-medium text-gray-700">Message:</label>
                        <textarea id="message" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald h-32" placeholder="Your message"></textarea>
                      </div>

                      <button type="submit" id="send-email-submit-btn" class="px-5 py-2.5 bg-emerald text-white rounded-lg hover:bg-opacity-90 transition font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Queue Email for Sending
                      </button>
                    </form>

                    <p id="sendStatus" class="mt-4 text-sm text-gray-600"></p>
                  </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Modals -->

    <!-- Add Sender Modal -->
    <div id="add-sender-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add Email Sender Account</h3>
                <form id="add-sender-form" class="space-y-4">
                    <div>
                        <label for="sender-email" class="block text-sm font-medium text-gray-700 text-left">Email Address</label>
                        <input type="email" id="sender-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="name@example.com">
                    </div>
                    <div>
                        <label for="sender-name" class="block text-sm font-medium text-gray-700 text-left">Display Name</label>
                        <input type="text" id="sender-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="Data Compass Bot">
                    </div>
                    <div>
                        <label for="sender-type" class="block text-sm font-medium text-gray-700 text-left">Authentication Type</label>
                        <select id="sender-type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                            <option value="gmail">Google/Gmail (Recommended)</option>
                            <option value="outlook">Outlook/Microsoft</option>
                            <option value="smtp">SMTP (Manual)</option>
                        </select>
                    </div>

                    <!-- OAuth Section (Visible by default) -->
                    <div id="oauth-section" class="space-y-4">
                        <button type="button" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fab fa-google mr-2"></i>Connect with Google (Requires Backend)
                        </button>
                    </div>

                    <!-- SMTP Section (Hidden by default) -->
                    <div id="smtp-section" class="space-y-4 hidden">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="smtp-host" class="block text-sm font-medium text-gray-700 text-left">Host</label>
                                <input type="text" id="smtp-host" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="smtp.example.com">
                            </div>
                            <div>
                                <label for="smtp-port" class="block text-sm font-medium text-gray-700 text-left">Port</label>
                                <input type="number" id="smtp-port" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="587">
                            </div>
                        </div>
                        <div>
                            <label for="smtp-user" class="block text-sm font-medium text-gray-700 text-left">Username</label>
                            <input type="text" id="smtp-user" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="username">
                        </div>
                        <div>
                            <label for="smtp-password" class="block text-sm font-medium text-gray-700 text-left">Password / App Password</label>
                            <input type="password" id="smtp-password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="****************">
                            <p class="text-red-500 text-xs mt-1">For security, passwords are NOT saved to the database from this form.</p>
                        </div>
                        <div>
                            <label for="smtp-tls" class="block text-sm font-medium text-gray-700 text-left">Security</label>
                            <select id="smtp-tls" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                <option value="tls">TLS/STARTTLS</option>
                                <option value="ssl">SSL/Explicit TLS</option>
                            </select>
                        </div>
                    </div>

                    <div class="items-center px-4 py-3">
                        <button type="submit" class="w-full px-4 py-2 bg-emerald text-white text-base font-medium rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-emerald">
                            Save Sender
                        </button>
                        <button type="button" class="close-modal-btn w-full mt-3 px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Email Modal -->
    <div id="schedule-email-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Schedule Standard Email</h3>
                <form id="schedule-email-form" class="space-y-4 text-left">
                    
                    <!-- Sender and Recipient -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="email-sender" class="block text-sm font-medium text-gray-700">Sender Account</label>
                            <select id="email-sender" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                <option value="">Select a sender...</option>
                            </select>
                        </div>
                        <div>
                            <label for="email-recipients" class="block text-sm font-medium text-gray-700">Recipients (comma-separated)</label>
                            <input type="text" id="email-recipients" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="user1@example.com, user2@example.com">
                        </div>
                    </div>

                    <!-- Subject and Body -->
                    <div>
                        <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                        <input type="text" id="email-subject" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="Important Announcement">
                    </div>
                    <div>
                        <label for="email-body" class="block text-sm font-medium text-gray-700">Email Body</label>
                        <textarea id="email-body" rows="6" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="Enter your email content here..."></textarea>
                    </div>

                    <!-- Schedule -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="email-recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                            <select id="email-recurrence" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald">
                                <option value="one-off">One-off (Send Now/Once)</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom (CRON)</option>
                            </select>
                        </div>
                        <div id="custom-recurrence-section" class="hidden">
                            <label for="email-cron" class="block text-sm font-medium text-gray-700">CRON Expression</label>
                            <input type="text" id="email-cron" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald focus:ring-emerald" placeholder="0 8 * * 1 (Every Monday at 8:00 AM)">
                        </div>
                    </div>
                    
                    <!-- Submission -->
                    <div class="items-center pt-3">
                        <button type="submit" class="w-full px-4 py-2 bg-emerald text-white text-base font-medium rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-emerald">
                            Schedule Email
                        </button>
                        <button type="button" class="close-modal-btn w-full mt-3 px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JAVASCRIPT (MERGED & UPDATED WITH FIREBASE)                         -->
    <!-- =================================S================================== -->
    <script type="module">
        // -------------------------------------------
        // FIREBASE IMPORTS (MOVED TO TOP FOR MODULE SYNTAX)
        // -------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getDatabase, ref, set, push, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            
            // -------------------------------------------
            // FIREBASE CONFIG (From Instructions)
            // -------------------------------------------
            // IMPORTANT: Replace placeholders with your actual Firebase project settings
            const firebaseConfig = {
              apiKey: "YOUR_API_KEY", // Get this from your Firebase project settings
              authDomain: "datacompass360-3b5d9.firebaseapp.com",
              databaseURL: "https://datacompass360-3b5d9-default-rtdb.firebaseio.com/", // This matches your instructions
              projectId: "datacompass360-3b5d9",
              storageBucket: "datacompass360-3b5d9.appspot.com",
              messagingSenderId: "YOUR_SENDER_ID", // Get this from Firebase
              appId: "YOUR_APP_ID" // Get this from Firebase
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            
            // -------------------------------------------
            // CONFIG
            // -------------------------------------------
            
            const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT9E7TTXJgBm3CBY0Oydz5qQ_QLaP-8Za5O2GSitCWFvOSI9tt-nEaSS64P7NPX6h6aJluZ4bA16nIO/pub?gid=0&single=true&output=csv';
            
            // Hot Picks Config
            const ROWS_PER_PAGE = 10;
            const FREQUENT_WINNER_MIN_APPEARANCES = 3;
            const FREQUENT_WINNER_MIN_WINS = 3;
            const OVER_2_5_HTEAM_SCORED = 1.8;
            const OVER_2_5_ATEAM_SCORED = 1.8;
            const OVER_2_5_HTEAM_CONCEDED = 1.5;
            const OVER_2_5_ATEAM_CONCEDED = 1.5;


            // -------------------------------------------
            // STATE (Merged)
            // -------------------------------------------
            
            // Hot Picks State
            let allData = [];
            let uniqueDates = new Set();
            let uniqueLeagues = new Set();
            let frequentWinnerTeams = [];
            
            let table1FilteredData = [];
            let table2FilteredData = [];
            
            let table1CurrentPage = 1;
            let table2CurrentPage = 1;

            // -------------------------------------------
            // DOM Element Cache (Merged)
            // -------------------------------------------
            const dom = {
                navTabButtons: document.querySelectorAll('.nav-tab-button'),
                tabContents: document.querySelectorAll('.tab-content'),
                notification: {
                    popup: document.getElementById('notification-popup'),
                    message: document.getElementById('notification-message'),
                },
                // Modals
                modals: {
                    addSender: document.getElementById('add-sender-modal'),
                    scheduleEmail: document.getElementById('schedule-email-modal'),
                    designReport: document.getElementById('design-report-modal'),
                },
                // Buttons
                buttons: {
                    addEmail: document.getElementById('add-email-btn'),
                    scheduleEmail: document.getElementById('schedule-email-btn'),
                    designReport: document.getElementById('design-report-btn'),
                    closeModal: document.querySelectorAll('.close-modal-btn'),
                },
                // Forms
                forms: {
                    addSender: document.getElementById('add-sender-form'),
                    scheduleEmail: document.getElementById('schedule-email-form'),
                    designReport: document.getElementById('design-report-form'),
                    sendEmail: document.getElementById('sendEmailForm'), // <-- ADDED
                },
                // Form Controls
                senderType: document.getElementById('sender-type'),
                oauthSection: document.getElementById('oauth-section'),
                smtpSection: document.getElementById('smtp-section'),
                emailRecurrence: document.getElementById('email-recurrence'),
                customRecurrence: document.getElementById('custom-recurrence-section'),
                
                // Table 1 (from hot-picks)
                table1: {
                    loader: document.getElementById('table-1-loader'),
                    wrapper: document.getElementById('table-1-wrapper'),
                    dateFilter: document.getElementById('date-filter-1'),
                    leagueFilter: document.getElementById('league-filter-1'),
                    tbody: document.getElementById('frequent-winners-tbody'),
                    prevBtn: document.getElementById('prev-btn-1'),
                    nextBtn: document.getElementById('next-btn-1'),
                    pageInfo: document.getElementById('page-info-1'),
                },
                // Table 2 (from hot-picks)
                table2: {
                    loader: document.getElementById('table-2-loader'),
                    wrapper: document.getElementById('table-2-wrapper'),
                    dateFilter: document.getElementById('date-filter-2'),
                    leagueFilter: document.getElementById('league-filter-2'),
                    tbody: document.getElementById('over-2-5-tbody'),
                    prevBtn: document.getElementById('prev-btn-2'),
                    nextBtn: document.getElementById('next-btn-2'),
                    pageInfo: document.getElementById('page-info-2'),
                },
                // Email Integration Tables
                sendersTableBody: document.getElementById('senders-table-body'),
                schedulingTableBody: document.getElementById('scheduling-table-body'),
                
                // Email Integration Selects
                emailSenderSelect: document.getElementById('email-sender'),
                reportSenderSelect: document.getElementById('report-sender'),
                reportLeagueFilter: document.getElementById('report-league'),

                // Send Email Tab (NEW)
                sendStatus: document.getElementById('sendStatus'), // <-- ADDED
                sendEmailSubmitBtn: document.getElementById('send-email-submit-btn'), // <-- ADDED
            };

            // -------------------------------------------
            // UTILITY FUNCTIONS (Merged)
            // -------------------------------------------

            function showNotification(message, type = 'info') {
                const popup = dom.notification.popup;
                dom.notification.message.textContent = message;
                popup.classList.remove('bg-emerald', 'bg-red-500', 'bg-blue-500', 'hidden');
                if (type === 'success') popup.classList.add('bg-emerald');
                else if (type === 'error') popup.classList.add('bg-red-500');
                else popup.classList.add('bg-blue-500');
                popup.classList.remove('hidden');
                setTimeout(() => popup.classList.add('hidden'), 3000);
            }

            /**
             * Parses a match result string (e.g., "2-1") and determines the winner.
             * @param {string} resultString - The match result.
             * @returns {'home' | 'away' | 'draw' | null} - The winner.
             */
            function getWinnerFromScore(resultString) {
                if (!resultString || typeof resultString !== 'string') return null;
                const scores = resultString.split('-').map(s => parseInt(s.trim(), 10));
                if (scores.length === 2 && !isNaN(scores[0]) && !isNaN(scores[1])) {
                    if (scores[0] > scores[1]) return 'home';
                    if (scores[1] > scores[0]) return 'away';
                    if (scores[0] === scores[1]) return 'draw';
                }
                return null;
            }
            
            /**
             * Parses a match result string (e.g., "2-1") and calculates total goals.
             * @param {string} resultString - The match result.
             * @returns {number | '—'} - The total goals or '—'.
             */
            function calculateTotalGoals(resultString) {
                if (!resultString || typeof resultString !== 'string') return '—';
                const scores = resultString.split('-').map(s => parseInt(s.trim(), 10));
                if (scores.length === 2 && !isNaN(scores[0]) && !isNaN(scores[1])) {
                    return scores[0] + scores[1];
                }
                return '—';
            }

            /**
             * Sanitizes and formats a value for display in a table.
             * @param {string | number | undefined} value - The value from the data.
             * @returns {string} - The formatted value.
             */
            function formatCell(value) {
                if (value === undefined || value === null || value === '') {
                    return '—';
                }
                return String(value);
            }
            
            // -------------------------------------------
            // NAVIGATION (from email)
            // -------------------------------------------
            
            function switchTab(tabName) {
                dom.tabContents.forEach(content => content.classList.add('hidden'));
                dom.navTabButtons.forEach(button => button.classList.remove('active'));

                const activeContent = document.getElementById(`${tabName}-tab`);
                const activeButton = document.querySelector(`.nav-tab-button[data-tab="${tabName}"]`);
                
                if (activeContent) activeContent.classList.remove('hidden');
                if (activeButton) activeButton.classList.add('active');
            }

            // -------------------------------------------
            // DATA FETCHING & PROCESSING (from hot-picks)
            // -------------------------------------------

            /**
             * Fetches and parses the CSV data from the Google Sheet.
             */
            async function fetchData() {
                try {
                    if (!GOOGLE_SHEET_CSV_URL || GOOGLE_SHEET_CSV_URL.includes('S-H-O-L-D-E-R')) {
                        showNotification('Error: Google Sheet URL is not set. Please update the script.', 'error');
                        dom.table1.loader.classList.add('hidden');
                        dom.table2.loader.classList.add('hidden');
                        return;
                    }
                    
                    Papa.parse(GOOGLE_SHEET_CSV_URL, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            allData = results.data;
                            processData();
                            populateFilters();
                            renderTable1();
                            renderTable2();
                            dom.table1.loader.classList.add('hidden');
                            dom.table1.wrapper.classList.remove('hidden');
                            dom.table2.loader.classList.add('hidden');
                            dom.table2.wrapper.classList.remove('hidden');
                            showNotification('Data loaded successfully!', 'success');
                        },
                        error: (err) => {
                            showNotification(`Error fetching data: ${err.message}`, 'error');
                            dom.table1.loader.classList.add('hidden');
                            dom.table2.loader.classList.add('hidden');
                        }
                    });
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                    dom.table1.loader.classList.add('hidden');
                    dom.table2.loader.classList.add('hidden');
                }
            }

            /**
             * Processes the raw data to find unique filters and frequent winners.
             */
            function processData() {
                const teamStats = {};

                allData.forEach(row => {
                    const homeTeam = row['Home Team'];
                    const awayTeam = row['Away Team'];
                    
                    // Populate filters
                    if (row['Date']) uniqueDates.add(row['Date']);
                    if (row['League']) uniqueLeagues.add(row['League']);

                    // Initialize team stats if not present
                    if (homeTeam) {
                        if (!teamStats[homeTeam]) teamStats[homeTeam] = { appearances: 0, wins: 0 };
                        teamStats[homeTeam].appearances++;
                    }
                    if (awayTeam) {
                        if (!teamStats[awayTeam]) teamStats[awayTeam] = { appearances: 0, wins: 0 };
                        teamStats[awayTeam].appearances++;
                    }

                    // Calculate wins
                    const winner = getWinnerFromScore(row['Match Result']);
                    if (winner === 'home' && homeTeam) {
                        teamStats[homeTeam].wins++;
                    } else if (winner === 'away' && awayTeam) {
                        teamStats[awayTeam].wins++;
                    }
                });

                // Determine the set of frequent winner teams
                frequentWinnerTeams = Object.keys(teamStats).filter(team => 
                    teamStats[team].appearances > FREQUENT_WINNER_MIN_APPEARANCES && 
                    teamStats[team].wins >= FREQUENT_WINNER_MIN_WINS
                );
            }

            /**
             * Populates the filter dropdowns with unique, sorted values.
             */
            function populateFilters() {
                // Sort dates (newest to oldest)
                const sortedDates = [...uniqueDates].sort((a, b) => new Date(b) - new Date(a));
                // Sort leagues (A-Z)
                const sortedLeagues = [...uniqueLeagues].sort();

                const dateOptions = sortedDates.map(date => `<option value="${date}">${date}</option>`).join('');
                const leagueOptions = sortedLeagues.map(league => `<option value="${league}">${league}</option>`).join('');

                dom.table1.dateFilter.innerHTML += dateOptions;
                dom.table1.leagueFilter.innerHTML += leagueOptions;
                dom.table2.dateFilter.innerHTML += dateOptions;
                dom.table2.leagueFilter.innerHTML += leagueOptions;
                
                // Also populate report designer league dropdown
                if (dom.reportLeagueFilter) {
                    dom.reportLeagueFilter.innerHTML += leagueOptions;
                }
            }

            // -------------------------------------------
            // TABLE 1: FREQUENT WINNERS (from hot-picks)
            // -------------------------------------------

            function renderTable1() {
                const dateFilter = dom.table1.dateFilter.value;
                const leagueFilter = dom.table1.leagueFilter.value;

                // 1. Apply Filters
                table1FilteredData = allData.filter(row => {
                    const matchesTeam = frequentWinnerTeams.includes(row['Home Team']) || frequentWinnerTeams.includes(row['Away Team']);
                    const matchesDate = !dateFilter || row['Date'] === dateFilter;
                    const matchesLeague = !leagueFilter || row['League'] === leagueFilter;
                    return matchesTeam && matchesDate && matchesLeague;
                });

                // 2. Apply Pagination
                const totalPages = Math.ceil(table1FilteredData.length / ROWS_PER_PAGE);
                if (table1CurrentPage > totalPages) table1CurrentPage = 1;
                if (table1CurrentPage < 1) table1CurrentPage = 1;
                
                const startIndex = (table1CurrentPage - 1) * ROWS_PER_PAGE;
                const endIndex = startIndex + ROWS_PER_PAGE;
                const paginatedData = table1FilteredData.slice(startIndex, endIndex);

                // 3. Generate HTML
                let html = '';
                if (paginatedData.length === 0) {
                    // Updated colspan to 9
                    html = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No matches found for the selected criteria.</td></tr>';
                } else {
                    paginatedData.forEach(row => {
                        // Updated row template
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Confidence %'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Prediction'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Predicted Outcome'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Match Result'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Home Team'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Away Team'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Predicted Probability (%)'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Expected Outcome'])}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Probability'])}</td>
                            </tr>
                        `;
                    });
                }
                dom.table1.tbody.innerHTML = html;

                // 4. Update Pagination UI
                dom.table1.pageInfo.textContent = `Page ${table1CurrentPage} of ${totalPages || 1}`;
                dom.table1.prevBtn.disabled = table1CurrentPage === 1;
                dom.table1.nextBtn.disabled = table1CurrentPage === totalPages || totalPages === 0;
            }

            // -------------------------------------------
            // TABLE 2: OVER 2.5 PREDICTION (from hot-picks)
            // -------------------------------------------

            function renderTable2() {
                const dateFilter = dom.table2.dateFilter.value;
                const leagueFilter = dom.table2.leagueFilter.value;

                // 1. Apply Filters
                table2FilteredData = allData.filter(row => {
                    const hTeamScored = parseFloat(row['Hteam Avg Scored']);
                    const aTeamScored = parseFloat(row['Ateam Avg Scored']);
                    const hTeamConceded = parseFloat(row['Hteam Avg Conceded']);
                    const aTeamConceded = parseFloat(row['Ateam Avg Conceded']);

                    const matchesStats = hTeamScored >= OVER_2_5_HTEAM_SCORED &&
                                         aTeamScored >= OVER_2_5_ATEAM_SCORED &&
                                         hTeamConceded >= OVER_2_5_HTEAM_CONCEDED &&
                                         aTeamConceded >= OVER_2_5_ATEAM_CONCEDED;
                    
                    const matchesDate = !dateFilter || row['Date'] === dateFilter;
                    const matchesLeague = !leagueFilter || row['League'] === leagueFilter;
                    
                    return matchesStats && matchesDate && matchesLeague;
                });

                // 2. Apply Pagination
                const totalPages = Math.ceil(table2FilteredData.length / ROWS_PER_PAGE);
                if (table2CurrentPage > totalPages) table2CurrentPage = 1;
                if (table2CurrentPage < 1) table2CurrentPage = 1;

                const startIndex = (table2CurrentPage - 1) * ROWS_PER_PAGE;
                const endIndex = startIndex + ROWS_PER_PAGE;
                const paginatedData = table2FilteredData.slice(startIndex, endIndex);

                // 3. Generate HTML
                let html = '';
                if (paginatedData.length === 0) {
                    // Updated colspan to 14
                    html = '<tr><td colspan="14" class="text-center py-4 text-gray-500">No matches found for the selected criteria.</td></tr>';
                } else {
                    paginatedData.forEach(row => {
                        const totalGoals = calculateTotalGoals(row['Match Result']);
                        const rowClass = totalGoals >= 3 ? 'bg-green-100 hover:bg-green-200' : 'hover:bg-gray-50';
                        
                        // Updated row template
                        html += `
                            <tr class="${rowClass}">
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Hteam Avg Scored'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Hteam Avg Conceded'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Ateam Avg Scored'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Ateam Avg Conceded'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Home Team'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Away Team'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Confidence %'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Prediction'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Predicted Outcome'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Predicted Probability (%)'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Match Result'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Expected Outcome'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${formatCell(row['Probability'])}</td>
                                <td class="px-2 py-3 whitespace-nowrap text-sm font-bold ${totalGoals >= 3 ? 'text-green-800' : 'text-gray-900'}">${totalGoals}</td>
                            </tr>
                        `;
                    });
                }
                dom.table2.tbody.innerHTML = html;

                // 4. Update Pagination UI
                dom.table2.pageInfo.textContent = `Page ${table2CurrentPage} of ${totalPages || 1}`;
                dom.table2.prevBtn.disabled = table2CurrentPage === 1;
                dom.table2.nextBtn.disabled = table2CurrentPage === totalPages || totalPages === 0;
            }

            // -------------------------------------------
            // FIREBASE: RENDER SENDER TABLE (NEW)
            // -------------------------------------------
            function renderSendersTable(senders) {
                let html = '';
                let senderOptions = '<option value="">Select a sender...</option>';

                if (!senders || Object.keys(senders).length === 0) {
                    html = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No senders configured. Add one to get started.</td></tr>';
                    senderOptions = '<option value="">No senders available</option>';
                } else {
                    for (const id in senders) {
                        const sender = senders[id];
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${sender.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${sender.status || 'Pending'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCell(sender.email)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCell(sender.name)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCell(sender.type)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                    <button class="text-red-600 hover:text-red-800 delete-sender-btn" data-id="${id}">Delete</button>
                                </td>
                            </tr>
                        `;
                        senderOptions += `<option value="${id}">${sender.name || sender.email} (${sender.email})</option>`;
                    }
                }
                dom.sendersTableBody.innerHTML = html;
                dom.emailSenderSelect.innerHTML = senderOptions;
                dom.reportSenderSelect.innerHTML = senderOptions;
            }

            // -------------------------------------------
            // FIREBASE: RENDER SCHEDULE TABLE (NEW)
            // -------------------------------------------
            function renderScheduledTable(schedules) {
                let html = '';
                if (!schedules || Object.keys(schedules).length === 0) {
                    html = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No emails scheduled.</td></tr>';
                } else {
                     for (const id in schedules) {
                        const job = schedules[id];
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                        ${job.status || 'Pending'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCell(job.subject)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCell(job.recipients)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCell(job.recurrence)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.recurrence === 'one-off' ? 'Once' : 'Recurring'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                    <button class="text-red-600 hover:text-red-800 delete-schedule-btn" data-id="${id}">Delete</button>
                                </td>
                            </tr>
                        `;
                    }
                }
                dom.schedulingTableBody.innerHTML = html;
            }

            
            // -------------------------------------------
            // EVENT LISTENERS (Merged & Updated)
            // -------------------------------------------

            // --- Tab Navigation ---
            dom.navTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            // --- Modal & Form Logic (from email) ---
            // Open Modals
            if (dom.buttons.addEmail) {
                dom.buttons.addEmail.addEventListener('click', () => dom.modals.addSender.classList.remove('hidden'));
            }
            if (dom.buttons.scheduleEmail) {
                dom.buttons.scheduleEmail.addEventListener('click', () => dom.modals.scheduleEmail.classList.remove('hidden'));
            }
            if (dom.buttons.designReport) {
                dom.buttons.designReport.addEventListener('click', () => dom.modals.designReport.classList.remove('hidden'));
            }
            // Close Modals
            dom.buttons.closeModal.forEach(button => {
                button.addEventListener('click', () => {
                    button.closest('.fixed').classList.add('hidden');
                });
            });
            // Toggle Sender Auth Type
            if (dom.senderType) {
                dom.senderType.addEventListener('change', (e) => {
                    if (e.target.value === 'smtp') {
                        dom.oauthSection.classList.add('hidden');
                        dom.smtpSection.classList.remove('hidden');
                    } else {
                        dom.oauthSection.classList.remove('hidden');
                        dom.smtpSection.classList.add('hidden');
                        if (e.target.value === 'gmail') {
                            dom.oauthSection.querySelector('button').innerHTML = '<i class="fab fa-google mr-2"></i>Connect with Google (Requires Backend)';
                        } else {
                            dom.oauthSection.querySelector('button').innerHTML = '<i class="fab fa-microsoft mr-2"></i>Connect with Outlook (Requires Backend)';
                        }
                    }
                });
            }
            // Toggle Custom Recurrence
            if (dom.emailRecurrence) {
                dom.emailRecurrence.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        dom.customRecurrence.classList.remove('hidden');
                    } else {
                        dom.customRecurrence.classList.add('hidden');
                    }
                });
            }

            // --- Form Submissions (UPDATED with Firebase) ---

            // Add Sender Form
            if(dom.forms.addSender) {
                dom.forms.addSender.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('sender-email').value;
                    const name = document.getElementById('sender-name').value;
                    const type = document.getElementById('sender-type').value;
                    
                    const senderData = {
                        email: email,
                        name: name,
                        type: type,
                        status: "pending", // Default status
                        lastTest: new Date().toISOString()
                    };

                    if (type === 'smtp') {
                        senderData.smtp = {
                            host: document.getElementById('smtp-host').value,
                            port: document.getElementById('smtp-port').value,
                            user: document.getElementById('smtp-user').value,
                            security: document.getElementById('smtp-tls').value,
                            // WARNING: Do not save password to DB from client
                        };
                    }

                    try {
                        // Save to Firebase at /emails/senders/
                        await push(ref(db, 'emails/senders'), senderData);
                        showNotification(`Sender ${email} configuration saved.`, 'success');
                        dom.forms.addSender.reset();
                        dom.modals.addSender.classList.add('hidden');
                    } catch (error) {
                        console.error("Error saving sender: ", error);
                        showNotification(`Error saving sender: ${error.message}`, 'error');
                    }
                });
            }

            // Schedule Email Form
            if(dom.forms.scheduleEmail) {
                dom.forms.scheduleEmail.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const senderId = document.getElementById('email-sender').value;
                    const recipients = document.getElementById('email-recipients').value;
                    const subject = document.getElementById('email-subject').value;
                    const body = document.getElementById('email-body').value;
                    let recurrence = document.getElementById('email-recurrence').value;

                    if (recurrence === 'custom') {
                        recurrence = document.getElementById('email-cron').value;
                    }
                    
                    const scheduleData = {
                        senderId: senderId,
                        recipients: recipients,
                        subject: subject,
                        body: body,
                        recurrence: recurrence,
                        status: "pending",
                        createdAt: new Date().toISOString()
                        // Note: Attachment handling requires Firebase Storage & backend logic
                    };

                    try {
                        // Save to Firebase at /emails/scheduled/
                        await push(ref(db, 'emails/scheduled'), scheduleData);
                        showNotification(`Email "${subject}" scheduled successfully.`, 'success');
                        dom.forms.scheduleEmail.reset();
                        dom.modals.scheduleEmail.classList.add('hidden');
                    } catch (error) {
                        console.error("Error scheduling email: ", error);
                        showNotification(`Error scheduling email: ${error.message}`, 'error');
                    }
                });
            }
            
            // Design Report Form
            if(dom.forms.designReport) {
                dom.forms.designReport.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Get all selected fields
                    const fields = [];
                    document.querySelectorAll('input[name="report_field"]:checked').forEach((checkbox) => {
                        fields.push(checkbox.value);
                    });

                    const reportJob = {
                        type: "report", // Differentiate from simple email
                        senderId: document.getElementById('report-sender').value,
                        recipients: document.getElementById('report-email-recipients').value,
                        subject: document.getElementById('report-name').value,
                        body: document.getElementById('report-body').value,
                        recurrence: document.getElementById('report-recurrence').value,
                        status: "pending",
                        createdAt: new Date().toISOString(),
                        reportConfig: {
                            league: document.getElementById('report-league').value,
                            minConfidence: document.getElementById('report-confidence').value,
                            fields: fields
                        }
                    };
                    
                    try {
                        // Save to Firebase at /emails/scheduled/
                        await push(ref(db, 'emails/scheduled'), reportJob);
                        showNotification(`Report "${reportJob.subject}" scheduled successfully.`, 'success');
                        dom.forms.designReport.reset();
                        dom.modals.designReport.classList.add('hidden');
                    } catch (error) {
                        console.error("Error scheduling report: ", error);
                        showNotification(`Error scheduling report: ${error.message}`, 'error');
                    }
                });
            }

            // --- NEW: Send Email Form (from user request) ---
            if (dom.forms.sendEmail) {
                dom.forms.sendEmail.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    dom.sendStatus.textContent = 'Queuing email...';
                    dom.sendEmailSubmitBtn.disabled = true;
                    dom.sendEmailSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Queuing...';

                    const recipient = document.getElementById('recipient').value;
                    const subject = document.getElementById('subject').value;
                    const message = document.getElementById('message').value;

                    try {
                        // This creates a new unique ID under /emails/queue/
                        const newEmailRef = push(ref(db, "emails/queue"));
                        
                        // This sets the data at that new ID
                        await set(newEmailRef, {
                            to: recipient,
                            subject: subject, // Use 'subject' key
                            message: message, // Use 'message' key
                            status: "pending",
                            timestamp: new Date().toISOString()
                        });

                        dom.sendStatus.textContent = "📨 Email request queued successfully! The backend will send it shortly.";
                        dom.forms.sendEmail.reset();
                    } catch (error) {
                        console.error("Error queuing email:", error);
                        showNotification(`Error queuing email: ${error.message}`, 'error');
                        dom.sendStatus.textContent = `Error: ${error.message}`;
                    } finally {
                        dom.sendEmailSubmitBtn.disabled = false;
                        dom.sendEmailSubmitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Queue Email for Sending';
                    }
                });
            }


            // --- Table 1 Listeners (from hot-picks) ---
            // --- FIX: Added guards to prevent null errors ---
            if (dom.table1.dateFilter) {
                dom.table1.dateFilter.addEventListener('change', () => {
                    table1CurrentPage = 1;
                    renderTable1();
                });
            }
            if (dom.table1.leagueFilter) {
                dom.table1.leagueFilter.addEventListener('change', () => {
                    table1CurrentPage = 1;
                    renderTable1();
                });
            }
            if (dom.table1.prevBtn) {
                dom.table1.prevBtn.addEventListener('click', () => {
                    if (table1CurrentPage > 1) {
                        table1CurrentPage--;
                        renderTable1();
                    }
                });
            }
            if (dom.table1.nextBtn) {
                dom.table1.nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(table1FilteredData.length / ROWS_PER_PAGE);
                    if (table1CurrentPage < totalPages) {
                        table1CurrentPage++;
                        renderTable1();
                    }
                });
            }

            // --- Table 2 Listeners (from hot-picks) ---
            // --- FIX: Added guards to prevent null errors ---
            if (dom.table2.dateFilter) {
                dom.table2.dateFilter.addEventListener('change', () => {
                    table2CurrentPage = 1;
                    renderTable2();
                });
            }
            if (dom.table2.leagueFilter) {
                dom.table2.leagueFilter.addEventListener('change', () => {
                    table2CurrentPage = 1;
                    renderTable2();
                });
            }
            if (dom.table2.prevBtn) {
                dom.table2.prevBtn.addEventListener('click', () => {
                    if (table2CurrentPage > 1) {
                        table2CurrentPage--;
                        renderTable2();
                    }
                });
            }
            if (dom.table2.nextBtn) {
                dom.table2.nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(table2FilteredData.length / ROWS_PER_PAGE);
                    if (table2CurrentPage < totalPages) {
                        table2CurrentPage++;
                        renderTable2();
                    }
                });
            }

            // --- FIREBASE DELETE LISTENERS (NEW) ---
            // --- FIX: Added guards to prevent null errors ---
            if (dom.sendersTableBody) {
                dom.sendersTableBody.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-sender-btn')) {
                        const id = e.target.dataset.id;
                        if (id) {
                            try {
                                await remove(ref(db, `emails/senders/${id}`));
                                showNotification('Sender deleted successfully.', 'success');
                            } catch (error) {
                                showNotification(`Error deleting sender: ${error.message}`, 'error');
                            }
                        }
                    }
                });
            }

            if (dom.schedulingTableBody) {
                dom.schedulingTableBody.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-schedule-btn')) {
                        const id = e.target.dataset.id;
                        if (id) {
                            try {
                                await remove(ref(db, `emails/scheduled/${id}`));
                                showNotification('Scheduled item deleted.', 'success');
                            } catch (error) {
                                showNotification(`Error deleting item: ${error.message}`, 'error');
                            }
                        }
                    }
                });
            }
            
            // -------------------------------------------
            // INITIALIZATION (Merged & Updated)
            // -------------------------------------------
            
            // Set default tab on page load
            switchTab('hot-picks');
            
            // Trigger change event to set initial auth UI (for email tab)
            if(dom.senderType) {
                dom.senderType.dispatchEvent(new Event('change'));
            }

            // Load data for Hot Picks tables
            fetchData();

            // --- FIREBASE REALTIME LISTENERS (NEW) ---
            try {
                // Listen for senders
                const sendersRef = ref(db, 'emails/senders');
                // --- FIX: Replaced 'onSnapshot' with 'onValue' ---
                onValue(sendersRef, (snapshot) => {
                    const data = snapshot.val();
                    renderSendersTable(data);
                });

                // Listen for schedules
                const scheduledRef = ref(db, 'emails/scheduled');
                // --- FIX: Replaced 'onSnapshot' with 'onValue' ---
                onValue(scheduledRef, (snapshot) => {
                    const data = snapshot.val();
                    renderScheduledTable(data);
                });
            } catch (error) {
                showNotification('Error connecting to Firebase. Check your config and API key.', 'error');
                console.error("Firebase connection error:", error);
            }
        
        }); // --- Closes DOMContentLoaded listener ---
    </script>
</body>
</html>
